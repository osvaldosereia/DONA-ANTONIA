<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Cestas Dona Ant√¥nia | Log√≠stica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            main: '#c2185b', // Rosa Dona Ant√¥nia
                            dark: '#8c1141',
                            light: '#fce4ec',
                            accent: '#2e7d32', // Verde Carvalima
                            whatsapp: '#25D366'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Tabela estilo Planilha */
        .spreadsheet-table th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        .spreadsheet-table td { white-space: nowrap; }
        .spreadsheet-container { max-height: 70vh; overflow: auto; border: 1px solid #e5e7eb; }
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; borderRadius: 4px; }
        /* Foto grande no mobile */
        .mobile-house-photo { width: 100%; height: 250px; object-fit: cover; border-radius: 8px 8px 0 0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans text-sm h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-20 flex-none">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-brand-main text-white p-2 rounded-lg shadow-md">
                    <i class="fa-solid fa-basket-shopping text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-brand-main">Super Cestas Dona Ant√¥nia</h1>
                    <p class="text-xs text-gray-500 font-semibold">Log√≠stica Carvalima <span class="text-brand-accent text-[10px] bg-green-100 px-1 rounded border border-green-200">PARCEIRO</span></p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Seletor de Perfil -->
                <select id="userRole" onchange="App.switchRole(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-brand-main focus:border-brand-main block p-2">
                    <option value="admin">üëë Admin (Dona Ant√¥nia)</option>
                    <optgroup label="Motoristas" id="driverSelectOptions">
                        <!-- Preenchido via JS -->
                    </optgroup>
                </select>
            </div>
        </div>
    </header>

    <!-- LAYOUT PRINCIPAL -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR (Apenas Admin) -->
        <aside id="sidebar" class="w-16 md:w-56 bg-white border-r border-gray-200 flex-none flex flex-col hidden md:flex transition-all duration-300">
            <nav class="p-2 space-y-1 mt-4 flex-1">
                <button onclick="App.setTab('dashboard')" id="btn-dashboard" class="nav-btn w-full text-left px-3 py-2 rounded-md hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-colors text-gray-600">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> <span class="hidden md:inline">Dashboard</span>
                </button>
                
                <div class="px-3 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-2 hidden md:block">Log√≠stica</div>
                
                <button onclick="App.setTab('entregas')" id="btn-entregas" class="nav-btn w-full text-left px-3 py-2 rounded-md hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-colors text-gray-600">
                    <i class="fa-solid fa-truck-ramp-box w-5 text-center"></i> <span class="hidden md:inline">Entregas (Rotas)</span>
                </button>
                <button onclick="App.setTab('rotas')" id="btn-rotas" class="nav-btn w-full text-left px-3 py-2 rounded-md hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-colors text-gray-600">
                    <i class="fa-solid fa-map-location-dot w-5 text-center"></i> <span class="hidden md:inline">Gest√£o de Rotas</span>
                </button>

                <div class="px-3 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-2 hidden md:block">Cadastros</div>

                <button onclick="App.setTab('funcionarios')" id="btn-funcionarios" class="nav-btn w-full text-left px-3 py-2 rounded-md hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-colors text-gray-600 font-bold bg-brand-light text-brand-main">
                    <i class="fa-solid fa-users w-5 text-center"></i> <span class="hidden md:inline">Funcion√°rios</span>
                </button>
                <button onclick="App.setTab('motoristas')" id="btn-motoristas" class="nav-btn w-full text-left px-3 py-2 rounded-md hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-colors text-gray-600">
                    <i class="fa-solid fa-id-card w-5 text-center"></i> <span class="hidden md:inline">Motoristas</span>
                </button>
                
                <hr class="my-2 border-gray-200">
                <button onclick="App.setTab('importar')" id="btn-importar" class="nav-btn w-full text-left px-3 py-2 rounded-md hover:bg-blue-50 hover:text-blue-600 flex items-center gap-3 transition-colors text-gray-600">
                    <i class="fa-solid fa-file-import w-5 text-center"></i> <span class="hidden md:inline">Importar JSON</span>
                </button>
            </nav>
            <div class="p-4 border-t border-gray-200 space-y-2">
                <div class="text-xs text-gray-500 mb-1">Configurar Zap Admin:</div>
                <input type="tel" id="adminPhoneConfig" onchange="App.setAdminPhone(this.value)" class="w-full text-xs border rounded p-1" placeholder="65999999999">
                <button onclick="App.exportData()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs py-2 px-2 rounded flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> <span class="hidden md:inline">Backup Dados</span>
                </button>
            </div>
        </aside>

        <!-- AREA DE CONTEUDO -->
        <main class="flex-1 overflow-auto bg-gray-50 p-4 relative">
            
            <!-- VIEW: DASHBOARD (ADMIN) -->
            <div id="view-dashboard" class="hidden max-w-5xl mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">üìä Vis√£o Geral</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">Total Entregas</p>
                        <p class="text-2xl font-bold text-gray-800" id="dashTotal">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-400">
                        <p class="text-xs text-gray-500 font-bold uppercase">Pendentes</p>
                        <p class="text-2xl font-bold text-yellow-600" id="dashPending">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">Entregues</p>
                        <p class="text-2xl font-bold text-green-600" id="dashDone">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-brand-main">
                        <p class="text-xs text-gray-500 font-bold uppercase">Progresso</p>
                        <p class="text-2xl font-bold text-brand-main" id="dashProgress">0%</p>
                    </div>
                </div>
                <h3 class="font-bold text-gray-700 mb-4">Progresso por Rota</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="dashRoutesList"></div>
            </div>

            <!-- VIEW: CADASTRO DE FUNCION√ÅRIOS (MASTER) -->
            <div id="view-funcionarios" class="hidden h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üë• Base de Funcion√°rios (Master)</h2>
                    <button onclick="App.openModal('modalFuncionario')" class="bg-brand-main hover:bg-brand-dark text-white px-3 py-2 rounded shadow text-xs font-bold">
                        + Novo Cadastro
                    </button>
                </div>
                <div class="bg-white p-3 rounded-t-lg border border-gray-200 flex items-center gap-2">
                    <i class="fa-solid fa-search text-gray-400"></i>
                    <input type="text" id="searchFunc" onkeyup="App.renderEmployeesTable()" placeholder="Buscar por Nome ou C√≥digo..." class="w-full text-sm outline-none">
                </div>
                <div class="spreadsheet-container bg-white shadow rounded-b-lg flex-1">
                    <table class="w-full text-left border-collapse spreadsheet-table">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 border-b">Foto</th>
                                <th class="px-4 py-3 border-b">C√≥d.</th>
                                <th class="px-4 py-3 border-b">Nome</th>
                                <th class="px-4 py-3 border-b">Endere√ßo</th>
                                <th class="px-4 py-3 border-b">Telefone</th>
                                <th class="px-4 py-3 border-b">Vizinhos</th>
                                <th class="px-4 py-3 border-b text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyFuncionarios" class="text-xs">
                            <!-- JS popula aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: PLANILHA DE ENTREGAS (LOGISTICA) -->
            <div id="view-entregas" class="hidden h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üì¶ Entregas Ativas (Log√≠stica)</h2>
                    <div class="flex gap-2">
                        <button onclick="App.openModal('modalEntrega')" class="bg-brand-main hover:bg-brand-dark text-white px-3 py-2 rounded shadow text-xs font-bold">
                            + Lan√ßar Entrega
                        </button>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-t-lg border border-gray-200 flex flex-wrap gap-3 items-center text-xs">
                    <label class="font-bold text-gray-600">Filtros:</label>
                    <select id="filterRoute" onchange="App.renderDeliveriesTable()" class="border rounded p-1">
                        <option value="">Todas as Rotas</option>
                    </select>
                    <select id="filterStatus" onchange="App.renderDeliveriesTable()" class="border rounded p-1">
                        <option value="">Todos Status</option>
                        <option value="pendente">Pendentes</option>
                        <option value="entregue">Entregues</option>
                    </select>
                    <input type="text" id="searchTable" onkeyup="App.renderDeliveriesTable()" placeholder="Buscar..." class="border rounded p-1 w-48">
                </div>

                <div class="spreadsheet-container bg-white shadow rounded-b-lg flex-1">
                    <table class="w-full text-left border-collapse spreadsheet-table">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 border-b">C√≥d.</th>
                                <th class="px-4 py-3 border-b">Nome</th>
                                <th class="px-4 py-3 border-b">Rota</th>
                                <th class="px-4 py-3 border-b">Status</th>
                                <th class="px-4 py-3 border-b">Entregue Em</th>
                                <th class="px-4 py-3 border-b">Recebido Por</th>
                                <th class="px-4 py-3 border-b text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyEntregas" class="text-xs"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: ROTAS & MOTORISTAS (Admin) -->
            <div id="view-rotas" class="hidden max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">üó∫Ô∏è Rotas e Previs√µes</h2>
                    <button onclick="App.openModal('modalRota')" class="bg-brand-main text-white px-4 py-2 rounded shadow text-sm font-bold">+ Criar Rota</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="gridRotas"></div>
            </div>
            
            <div id="view-motoristas" class="hidden max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">üöö Motoristas</h2>
                    <button onclick="App.openModal('modalMotorista')" class="bg-brand-main text-white px-4 py-2 rounded shadow text-sm font-bold">+ Novo Motorista</button>
                </div>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-700"><tr><th class="px-6 py-3">Nome</th><th class="px-6 py-3">Tel</th><th class="px-6 py-3">A√ß√µes</th></tr></thead>
                        <tbody id="listMotoristas"></tbody>
                    </table>
                </div>
            </div>

             <!-- VIEW: IMPORTAR (ADMIN) -->
             <div id="view-importar" class="hidden max-w-2xl mx-auto mt-10">
                <div class="bg-white p-8 rounded-lg shadow border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üì• Importa√ß√£o e Atualiza√ß√£o</h2>
                    <div class="space-y-6">
                        <div class="border-b pb-4">
                            <h3 class="font-bold text-brand-main mb-2">Op√ß√£o A: Gerar Entregas via Base Master</h3>
                            <p class="text-xs text-gray-500 mb-2">Cole apenas os C√ìDIGOS dos funcion√°rios que receber√£o cesta este m√™s. Ex: <code>["001", "005"]</code></p>
                            <textarea id="jsonInputCodes" class="w-full border p-2 text-xs h-24 rounded font-mono bg-gray-50" placeholder='["1001", "1002", "1003"]'></textarea>
                            <button onclick="App.importByCodes()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Gerar Entregas</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: MOBILE (MOTORISTA) -->
            <div id="view-driver-mobile" class="hidden pb-20">
                <div class="bg-brand-main text-white p-4 rounded-b-xl shadow-lg mb-4 sticky top-0 z-30">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-lg" id="driverWelcome">Ol√°, Motorista</h2>
                            <p class="text-xs opacity-90">Sua rota de hoje:</p>
                        </div>
                        <select id="driverRouteFilter" onchange="App.renderDriverView()" class="text-xs text-black p-1 rounded font-bold">
                            <!-- Rotas do motorista -->
                        </select>
                    </div>
                </div>
                
                <div id="driverDeliveriesList" class="px-4 space-y-4">
                    <!-- Cards Mobile -->
                </div>
            </div>

        </main>
    </div>

    <!-- MODAIS -->
    
    <!-- Modal Cadastro Funcion√°rio (Master) -->
    <div id="modalFuncionario" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <form onsubmit="App.saveEmployee(event)" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 border-b pb-2">Cadastro de Funcion√°rio</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-xs font-bold mb-1">C√≥d. Func.</label><input type="text" name="codigo" required class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold mb-1">Nome Completo</label><input type="text" name="nome" required class="w-full border rounded p-2 text-sm"></div>
            </div>
            <div class="mb-4"><label class="block text-xs font-bold mb-1">Endere√ßo Fixo</label><input type="text" name="endereco" required class="w-full border rounded p-2 text-sm"></div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-xs font-bold mb-1">Bairro</label><input type="text" name="bairro" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold mb-1">Cidade</label><input type="text" name="cidade" value="Cuiab√°" class="w-full border rounded p-2 text-sm"></div>
            </div>
            
            <div class="border-t border-b py-3 my-3 bg-gray-50 p-2 rounded">
                <label class="block text-xs font-bold mb-2 text-brand-main">üìû Contatos</label>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="block text-[10px] text-gray-500">Celular (Zap)</label><input type="tel" name="tel1" class="w-full border rounded p-1 text-sm"></div>
                    <div><label class="block text-[10px] text-gray-500">Vizinho 1</label><input type="tel" name="vizinho1" class="w-full border rounded p-1 text-sm"></div>
                    <div><label class="block text-[10px] text-gray-500">Vizinho 2</label><input type="tel" name="vizinho2" class="w-full border rounded p-1 text-sm"></div>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold mb-1">Foto da Casa (URL)</label>
                <input type="url" name="fotoCasa" placeholder="https://..." class="w-full border rounded p-2 text-sm">
                <p class="text-[10px] text-gray-500">Copie o link da imagem (Google Drive p√∫blico ou similar).</p>
            </div>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="App.closeModal('modalFuncionario')" class="px-4 py-2 rounded border hover:bg-gray-50 text-sm">Cancelar</button>
                <button type="submit" class="px-4 py-2 rounded bg-brand-main text-white font-bold hover:bg-brand-dark text-sm">Salvar Master</button>
            </div>
        </form>
    </div>

    <!-- Modal Nova Entrega (Lan√ßamento) -->
    <div id="modalEntrega" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <form onsubmit="App.saveDelivery(event)" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4">Lan√ßar Entrega (Avulsa)</h3>
            
            <div class="mb-4">
                <label class="block text-xs font-bold mb-1">Buscar Funcion√°rio</label>
                <select id="selectEmployeeDelivery" onchange="App.fillDeliveryForm(this.value)" class="w-full border rounded p-2 text-sm bg-gray-50">
                    <option value="">Selecione para preencher...</option>
                </select>
            </div>

            <hr class="my-4">

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-xs font-bold mb-1">C√≥d.</label><input type="text" name="codigo" id="delCodigo" required class="w-full border rounded p-2 text-sm bg-gray-100" readonly></div>
                <div><label class="block text-xs font-bold mb-1">Nome</label><input type="text" name="nome" id="delNome" required class="w-full border rounded p-2 text-sm bg-gray-100" readonly></div>
            </div>
            
            <div class="mb-4"><label class="block text-xs font-bold mb-1">Rota de Entrega</label><select name="rotaId" id="selectRouteModal" class="w-full border rounded p-2 text-sm"></select></div>
            
            <div class="flex justify-end gap-2">
                <button type="button" onclick="App.closeModal('modalEntrega')" class="px-4 py-2 rounded border hover:bg-gray-50 text-sm">Cancelar</button>
                <button type="submit" class="px-4 py-2 rounded bg-brand-main text-white font-bold text-sm">Lan√ßar na Rota</button>
            </div>
        </form>
    </div>

    <!-- Modais Gen√©ricos (Rota, Motorista, Confirma√ß√£o) -->
    <div id="modalRota" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <form onsubmit="App.saveRoute(event)" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold mb-4">Nova Rota</h3><input type="text" name="nome" placeholder="Nome" class="w-full border rounded p-2 mb-2"><select name="motoristaId" id="selectDriverModal" class="w-full border rounded p-2 mb-2"></select><input type="date" name="dataPrevisao" class="w-full border rounded p-2 mb-4"><div class="flex justify-end gap-2"><button type="button" onclick="App.closeModal('modalRota')" class="border p-2 rounded">Cancelar</button><button class="bg-brand-main text-white p-2 rounded">Salvar</button></div></form>
    </div>
    
    <div id="modalMotorista" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <form onsubmit="App.saveDriver(event)" class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6"><h3 class="font-bold mb-4">Novo Motorista</h3><input type="text" name="nome" placeholder="Nome" class="w-full border rounded p-2 mb-2"><input type="tel" name="telefone" placeholder="Tel" class="w-full border rounded p-2 mb-4"><div class="flex justify-end gap-2"><button type="button" onclick="App.closeModal('modalMotorista')" class="border p-2 rounded">Cancelar</button><button class="bg-brand-main text-white p-2 rounded">Salvar</button></div></form>
    </div>

    <div id="modalConfirmMobile" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-lg shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-1">Entregar Cesta?</h3>
            <p class="text-sm text-gray-500 mb-4">Func: <span id="confMobName" class="font-bold text-black"></span></p>
            <div class="mb-4">
                <label class="block text-xs font-bold mb-1 text-gray-700">Quem recebeu?</label>
                <div class="flex gap-2 mb-2"><input type="text" id="receiverNameInput" placeholder="Nome de quem recebeu" class="flex-1 border rounded p-2 text-sm"><button type="button" onclick="App.fillReceiverSelf()" class="bg-gray-200 text-xs px-3 py-2 rounded font-bold">O Pr√≥prio</button></div>
            </div>
            <div class="flex gap-2 mt-4 pt-4 border-t"><button onclick="document.getElementById('modalConfirmMobile').classList.add('hidden')" class="flex-1 py-3 border rounded">Cancelar</button><button onclick="App.confirmDeliveryMobile()" class="flex-1 py-3 bg-brand-whatsapp text-white rounded font-bold hover:bg-green-600 shadow-md">Confirmar</button></div>
        </div>
    </div>

<script>
const App = {
    key: 'dona_antonia_db_v6',
    db: {
        employees: [], // Cadastro Master
        deliveries: [], // Log√≠stica Ativa
        routes: [],
        drivers: [],
        adminPhone: ''
    },
    currentUser: 'admin',
    currentTab: 'dashboard',
    tempId: null,
    tempName: null,

    init() {
        this.load();
        if (this.db.employees.length === 0) this.seedData();
        this.updateSelectors();
        if(this.db.adminPhone) document.getElementById('adminPhoneConfig').value = this.db.adminPhone;
        this.switchRole('admin');
    },

    load() {
        const stored = localStorage.getItem(this.key);
        if (stored) {
            try { 
                const parsed = JSON.parse(stored);
                if (!parsed.employees) parsed.employees = []; // Migration
                this.db = parsed;
            } catch (e) { console.error("Erro load", e); }
        }
    },

    save() {
        localStorage.setItem(this.key, JSON.stringify(this.db));
        this.updateSelectors();
        if(this.currentUser === 'admin') this.setTab(this.currentTab);
        else this.renderDriverView();
    },

    seedData() {
        // Dados Simulados de Cuiab√°
        this.db.drivers = [
            { id: 'd1', nome: 'Carlos (Regi√£o Sul)', telefone: '65999991111' },
            { id: 'd2', nome: 'Marcos (Regi√£o Norte)', telefone: '65999992222' }
        ];
        this.db.routes = [
            { id: 'r1', nome: 'Rota 01 - Pedra 90/Tijucal', motoristaId: 'd1', dataPrevisao: '2026-01-15' },
            { id: 'r2', nome: 'Rota 02 - CPA/Centro', motoristaId: 'd2', dataPrevisao: '2026-01-16' }
        ];
        // 5 Cadastros Completos
        this.db.employees = [
            { id: 101, codigo: '1001', nome: 'Jo√£o da Silva', endereco: 'Rua 30, Qd 15, Casa 02', bairro: 'Pedra 90', cidade: 'Cuiab√°', tel1: '65992001001', vizinho1: '65992002002', vizinho2: '', fotoCasa: 'https://images.unsplash.com/photo-1600596542815-60c37c6525fa?w=500&q=80' },
            { id: 102, codigo: '1002', nome: 'Maria Aparecida', endereco: 'Rua Pernambuco, 550', bairro: 'CPA 2', cidade: 'Cuiab√°', tel1: '65992003003', vizinho1: '65992004004', vizinho2: '', fotoCasa: 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=500&q=80' },
            { id: 103, codigo: '1003', nome: 'Pedro Henrique', endereco: 'Av. Brasil, 1200', bairro: 'Santa Rosa', cidade: 'Cuiab√°', tel1: '65992005005', vizinho1: '', vizinho2: '', fotoCasa: 'https://images.unsplash.com/photo-1570129477492-45c003edd2be?w=500&q=80' },
            { id: 104, codigo: '1004', nome: 'Ana Clara', endereco: 'Rua dos L√≠rios, 88', bairro: 'Tijucal', cidade: 'Cuiab√°', tel1: '65992006006', vizinho1: '65992007007', vizinho2: '65992008008', fotoCasa: 'https://images.unsplash.com/photo-1572120360610-d971b9d7767c?w=500&q=80' },
            { id: 105, codigo: '1005', nome: 'Lucas Mendes', endereco: 'Rua C√¢ndido Mariano, 400', bairro: 'Centro', cidade: 'Cuiab√°', tel1: '65992009009', vizinho1: '', vizinho2: '', fotoCasa: 'https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?w=500&q=80' }
        ];
        // Gerar entregas baseadas nisso
        this.db.deliveries = this.db.employees.slice(0, 3).map(e => ({
            id: Date.now() + Math.random(),
            employeeId: e.id, // V√≠nculo
            codigo: e.codigo, nome: e.nome, rotaId: e.bairro.includes('CPA') ? 'r2' : 'r1',
            status: 'pendente', entregueEm: null, recebidoPor: ''
        }));
        this.save();
    },

    // --- CADASTRO FUNCION√ÅRIOS (MASTER) ---
    saveEmployee(e) {
        e.preventDefault();
        const f = e.target;
        const newEmp = {
            id: Date.now(),
            codigo: f.codigo.value, nome: f.nome.value, endereco: f.endereco.value,
            bairro: f.bairro.value, cidade: f.cidade.value,
            tel1: f.tel1.value, vizinho1: f.vizinho1.value, vizinho2: f.vizinho2.value,
            fotoCasa: f.fotoCasa.value
        };
        this.db.employees.push(newEmp);
        this.save();
        this.closeModal('modalFuncionario');
        f.reset();
    },

    renderEmployeesTable() {
        const tbody = document.getElementById('tableBodyFuncionarios');
        tbody.innerHTML = '';
        const search = document.getElementById('searchFunc').value.toLowerCase();
        
        this.db.employees.filter(e => e.nome.toLowerCase().includes(search) || e.codigo.includes(search)).forEach(e => {
            const img = e.fotoCasa ? `<img src="${e.fotoCasa}" class="w-8 h-8 rounded-full object-cover">` : '<div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">üè†</div>';
            
            tbody.innerHTML += `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${img}</td>
                    <td class="px-4 py-3 font-mono">${e.codigo}</td>
                    <td class="px-4 py-3 font-bold">${e.nome}</td>
                    <td class="px-4 py-3 text-xs">${e.endereco}, ${e.bairro}</td>
                    <td class="px-4 py-3 text-xs">${e.tel1}</td>
                    <td class="px-4 py-3 text-xs text-gray-500">${e.vizinho1 || '-'} <br> ${e.vizinho2 || ''}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="if(confirm('Excluir cadastro?')) { App.db.employees = App.db.employees.filter(x=>x.id!=${e.id}); App.save(); }" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    },

    // --- ENTREGAS (LOGISTICA) ---
    fillDeliveryForm(empId) {
        if(!empId) return;
        const emp = this.db.employees.find(e => e.id == empId);
        if(emp) {
            document.getElementById('delCodigo').value = emp.codigo;
            document.getElementById('delNome').value = emp.nome;
        }
    },

    saveDelivery(e) {
        e.preventDefault();
        const f = e.target;
        const codigo = f.codigo.value;
        const emp = this.db.employees.find(e => e.codigo == codigo);
        
        this.db.deliveries.push({
            id: Date.now(),
            employeeId: emp ? emp.id : null,
            codigo: codigo,
            nome: f.nome.value,
            rotaId: f.rotaId.value,
            status: 'pendente', entregueEm: null, recebidoPor: ''
        });
        this.save();
        this.closeModal('modalEntrega');
        f.reset();
    },
    
    // Importa√ß√£o por C√≥digos (Gera entregas baseado no Master)
    importByCodes() {
        const raw = document.getElementById('jsonInputCodes').value;
        if(!raw) return;
        try {
            const codes = JSON.parse(raw);
            let count = 0;
            codes.forEach(code => {
                const emp = this.db.employees.find(e => e.codigo == code);
                if(emp) {
                    // Evitar duplicidade na entrega ativa
                    const exists = this.db.deliveries.find(d => d.codigo == code && d.status == 'pendente');
                    if(!exists) {
                        this.db.deliveries.push({
                            id: Date.now() + Math.random(),
                            employeeId: emp.id,
                            codigo: emp.codigo, nome: emp.nome, rotaId: '',
                            status: 'pendente', entregueEm: null, recebidoPor: ''
                        });
                        count++;
                    }
                }
            });
            alert(`${count} entregas geradas com base no cadastro master!`);
            this.save();
        } catch(e) { alert("Erro JSON: " + e.message); }
    },

    // --- MOBILE DRIVER VIEW ---
    renderDriverView() {
        const container = document.getElementById('driverDeliveriesList');
        container.innerHTML = '';
        
        const routeFilter = document.getElementById('driverRouteFilter');
        const myRoutes = this.db.routes.filter(r => r.motoristaId == this.currentUser);
        
        if (routeFilter.options.length === 0 && myRoutes.length > 0) {
            myRoutes.forEach(r => routeFilter.innerHTML += `<option value="${r.id}">${r.nome}</option>`);
        }
        const selectedRouteId = routeFilter.value || (myRoutes[0] ? myRoutes[0].id : null);
        
        if (!selectedRouteId) {
            container.innerHTML = '<div class="text-center text-gray-500 mt-10 p-4">Sem rotas atribu√≠das.</div>';
            return;
        }

        const deliveries = this.db.deliveries.filter(d => d.rotaId === selectedRouteId);
        deliveries.sort((a,b) => a.status === 'entregue' ? 1 : -1);

        deliveries.forEach(d => {
            // Merge delivery data with master data for display
            const emp = this.db.employees.find(e => e.codigo == d.codigo) || {};
            const isDone = d.status === 'entregue';
            const tel = emp.tel1 || '';
            
            // Photo Logic
            const photoHTML = emp.fotoCasa ? 
                `<img src="${emp.fotoCasa}" class="mobile-house-photo" onerror="this.src='https://via.placeholder.com/400x200?text=Sem+Foto'">` : 
                `<div class="mobile-house-photo bg-gray-200 flex items-center justify-center text-gray-400"><i class="fa-solid fa-house text-4xl"></i></div>`;

            // Neighbors HTML
            let neighborsHTML = '';
            if(emp.vizinho1 || emp.vizinho2) {
                neighborsHTML = `<div class="bg-gray-50 p-2 rounded text-xs text-gray-600 mb-3 border border-gray-200">
                    <strong><i class="fa-solid fa-people-roof"></i> Vizinhos:</strong>
                    <div class="flex gap-2 mt-1">
                        ${emp.vizinho1 ? `<a href="tel:${emp.vizinho1}" class="text-blue-600 underline">Viz 1</a>` : ''}
                        ${emp.vizinho2 ? `<a href="tel:${emp.vizinho2}" class="text-blue-600 underline">Viz 2</a>` : ''}
                    </div>
                </div>`;
            }

            const cardHtml = `
                <div class="bg-white rounded-lg shadow-md border overflow-hidden ${isDone ? 'opacity-80' : ''}">
                    ${!isDone ? photoHTML : ''}
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-1 rounded">#${d.codigo}</span>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight">${d.nome}</h3>
                            </div>
                            ${isDone ? '<i class="fa-solid fa-check-circle text-green-500 text-xl"></i>' : ''}
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-2"><i class="fa-solid fa-location-dot text-red-400"></i> ${emp.endereco || 'Endere√ßo n√£o cadastrado'}</p>
                        <p class="text-xs text-gray-500 mb-3 ml-4">${emp.bairro || ''}</p>
                        
                        ${!isDone ? `
                            ${neighborsHTML}
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <a href="https://wa.me/55${tel.replace(/\D/g,'')}" target="_blank" class="bg-green-100 text-green-800 py-2 rounded text-center text-xs font-bold border border-green-200"><i class="fa-brands fa-whatsapp"></i> Zap</a>
                                <a href="tel:${tel}" class="bg-blue-100 text-blue-800 py-2 rounded text-center text-xs font-bold border border-blue-200"><i class="fa-solid fa-phone"></i> Ligar</a>
                            </div>
                            <button onclick="App.openConfirmMobile('${d.id}', '${d.nome}')" class="w-full bg-brand-main text-white py-3 rounded-lg text-sm font-bold shadow hover:bg-brand-dark">ENTREGAR</button>
                        ` : `
                            <div class="bg-green-50 p-2 rounded border border-green-100 text-xs text-green-800 mt-2">
                                <strong>Entregue:</strong> ${d.entregueEm}<br><strong>Recebido por:</strong> ${d.recebidoPor}
                            </div>
                        `}
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });
    },

    // --- GENERICOS (Reutilizados) ---
    renderDeliveriesTable() {
        const tbody = document.getElementById('tableBodyEntregas'); tbody.innerHTML = '';
        const filterR = document.getElementById('filterRoute').value;
        const filterS = document.getElementById('filterStatus').value;
        const search = document.getElementById('searchTable').value.toLowerCase();

        this.db.deliveries.filter(d => {
            if (filterR && d.rotaId !== filterR) return false;
            if (filterS && d.status !== filterS) return false;
            if (search && !d.nome.toLowerCase().includes(search)) return false;
            return true;
        }).forEach(d => {
            const rName = this.db.routes.find(r=>r.id===d.rotaId)?.nome || '-';
            const isDone = d.status === 'entregue';
            tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-3">${d.codigo}</td><td class="px-4 py-3 font-bold">${d.nome}</td><td class="px-4 py-3 text-xs">${rName}</td><td class="px-4 py-3"><span class="${isDone?'bg-green-100 text-green-800':'bg-yellow-100'} text-xs px-2 py-0.5 rounded">${d.status}</span></td><td class="px-4 py-3 text-xs">${d.entregueEm||'-'}</td><td class="px-4 py-3 text-xs">${d.recebidoPor||'-'}</td><td class="px-4 py-3 text-center"><button onclick="App.db.deliveries=App.db.deliveries.filter(x=>x.id!=${d.id});App.save();" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
    },

    // Config e Navega√ß√£o
    setAdminPhone(val) { this.db.adminPhone = val.replace(/\D/g, ''); this.save(); },
    switchRole(role) {
        this.currentUser = role;
        const sidebar = document.getElementById('sidebar');
        if (role === 'admin') {
            sidebar.classList.remove('hidden'); document.getElementById('view-driver-mobile').classList.add('hidden');
            this.setTab('dashboard');
        } else {
            sidebar.classList.add('hidden'); document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-driver-mobile').classList.remove('hidden');
            const drv = this.db.drivers.find(d => d.id == role);
            document.getElementById('driverWelcome').innerText = `Ol√°, ${drv ? drv.nome.split(' ')[0] : ''}`;
            this.renderDriverView();
        }
    },
    setTab(tab) {
        if(this.currentUser !== 'admin') return;
        this.currentTab = tab;
        document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-brand-light', 'text-brand-main'); b.classList.add('text-gray-600'); });
        document.getElementById(`btn-${tab}`).classList.add('bg-brand-light', 'text-brand-main');
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${tab}`).classList.remove('hidden');
        if(tab === 'dashboard') this.renderDashboard();
        if(tab === 'funcionarios') this.renderEmployeesTable();
        if(tab === 'entregas') this.renderDeliveriesTable();
        if(tab === 'rotas') this.renderRoutesGrid();
        if(tab === 'motoristas') this.renderDriversList();
    },
    updateSelectors() {
        const opts = document.getElementById('driverSelectOptions'); opts.innerHTML = '';
        this.db.drivers.forEach(d => opts.innerHTML += `<option value="${d.id}">üöö ${d.nome}</option>`);
        const rSel = document.getElementById('selectRouteModal'); if(rSel) { rSel.innerHTML = ''; this.db.routes.forEach(r => rSel.innerHTML += `<option value="${r.id}">${r.nome}</option>`); }
        const drvSel = document.getElementById('selectDriverModal'); if(drvSel) { drvSel.innerHTML = ''; this.db.drivers.forEach(d => drvSel.innerHTML += `<option value="${d.id}">${d.nome}</option>`); }
        const empSel = document.getElementById('selectEmployeeDelivery'); if(empSel) { empSel.innerHTML = '<option value="">Selecione...</option>'; this.db.employees.forEach(e => empSel.innerHTML += `<option value="${e.id}">${e.nome} (${e.codigo})</option>`); }
        const rFilt = document.getElementById('filterRoute'); if(rFilt) { rFilt.innerHTML = '<option value="">Todas</option>'; this.db.routes.forEach(r => rFilt.innerHTML += `<option value="${r.id}">${r.nome}</option>`); }
    },
    
    // Renderers Simplificados
    renderDashboard() {
        const total = this.db.deliveries.length, done = this.db.deliveries.filter(d=>d.status==='entregue').length;
        document.getElementById('dashTotal').innerText = total; document.getElementById('dashPending').innerText = total-done; document.getElementById('dashDone').innerText = done;
        document.getElementById('dashProgress').innerText = total?Math.round((done/total)*100)+'%':'0%';
        const list = document.getElementById('dashRoutesList'); list.innerHTML = '';
        this.db.routes.forEach(r => {
            const rt = this.db.deliveries.filter(d=>d.rotaId===r.id).length, rd = this.db.deliveries.filter(d=>d.rotaId===r.id&&d.status==='entregue').length;
            const pct = rt?Math.round((rd/rt)*100):0;
            list.innerHTML += `<div class="bg-white p-3 rounded border flex justify-between items-center"><span class="font-bold text-sm text-gray-700">${r.nome}</span><span class="font-bold text-brand-main">${pct}%</span></div>`;
        });
    },
    renderRoutesGrid() { const g=document.getElementById('gridRotas'); g.innerHTML=''; this.db.routes.forEach(r=>{ g.innerHTML+=`<div class="bg-white p-4 rounded border"><b>${r.nome}</b><br><small>Prev: ${r.dataPrevisao}</small><button onclick="App.db.routes=App.db.routes.filter(x=>x.id!='${r.id}');App.save();" class="float-right text-red-500"><i class="fa-solid fa-trash"></i></button></div>`})},
    renderDriversList() { const l=document.getElementById('listMotoristas'); l.innerHTML=''; this.db.drivers.forEach(d=>{ l.innerHTML+=`<tr><td class="px-6 py-4">${d.nome}</td><td class="px-6 py-4">${d.telefone}</td><td class="px-6 py-4"><button onclick="App.db.drivers=App.db.drivers.filter(x=>x.id!='${d.id}');App.save();" class="text-red-500">Excluir</button></td></tr>`})},
    
    // Confirma√ß√£o Mobile
    openConfirmMobile(id, nome) { this.tempId = id; this.tempName = nome; document.getElementById('confMobName').innerText = nome; document.getElementById('receiverNameInput').value = ''; document.getElementById('modalConfirmMobile').classList.remove('hidden'); },
    fillReceiverSelf() { document.getElementById('receiverNameInput').value = this.tempName; },
    confirmDeliveryMobile() {
        if(!this.tempId) return;
        const rec = document.getElementById('receiverNameInput').value.trim(); if(!rec) return alert("Quem recebeu?");
        const t = this.db.deliveries.find(d => d.id == this.tempId);
        if(t) { t.status = 'entregue'; t.recebidoPor = rec; t.entregueEm = new Date().toLocaleString('pt-BR'); this.save(); if(this.db.adminPhone) window.open(`https://wa.me/55${this.db.adminPhone}?text=${encodeURIComponent(`‚úÖ Entregue: ${t.nome}\nRecebido por: ${rec}`)}`, '_blank'); }
        document.getElementById('modalConfirmMobile').classList.add('hidden'); this.renderDriverView();
    },
    
    // Modais e Utils
    saveRoute(e) { e.preventDefault(); this.db.routes.push({id:'r'+Date.now(), nome:e.target.nome.value, motoristaId:e.target.motoristaId.value, dataPrevisao:e.target.dataPrevisao.value}); this.save(); this.closeModal('modalRota'); e.target.reset(); },
    saveDriver(e) { e.preventDefault(); this.db.drivers.push({id:'d'+Date.now(), nome:e.target.nome.value, telefone:e.target.telefone.value}); this.save(); this.closeModal('modalMotorista'); e.target.reset(); },
    openModal(id) { document.getElementById(id).classList.remove('hidden'); },
    closeModal(id) { document.getElementById(id).classList.add('hidden'); },
    exportData() { const blob = new Blob([JSON.stringify(this.db,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click(); }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
