<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- OTIMIZA√á√ÉO: viewport-fit=cover e user-scalable=no para sensa√ß√£o de App Nativo -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cesta Econ√¥mica | Fale com o Osvaldo</title>
    <meta name="description" content="Cestas B√°sicas em Cuiab√° e V√°rzea Grande. Qualidade e entrega r√°pida. Fale com o Osvaldo!">
    <meta name="theme-color" content="#008069">
    <meta name="robots" content="index, follow">

    <!-- PERFORMANCE: Preconnect para CDNs -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">

    <!-- ESTILOS EXTERNOS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- SEGURAN√áA: Headers simulados via Meta Tags -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https: data:;">
    <meta http-equiv="X-Frame-Options" content="DENY">

    <!-- SCHEMA MARKUP (SEO LOCAL - JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": "Dona Ant√¥nia Alimentos",
      "image": "https://donaantonia.com.br/img/logo.png",
      "telephone": "+5565998150975",
      "priceRange": "$$",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Cuiab√°",
        "addressRegion": "MT",
        "addressCountry": "BR"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": -15.6014,
        "longitude": -56.0979
      },
      "url": "https://donaantonia.com.br",
      "sameAs": [
        "https://instagram.com/cestas.dona.antonia.cuiaba.vg",
        "https://facebook.com/donaantonia"
      ]
    }
    </script>

    <!-- DATA LAYER INIT (META ADS / ANALYTICS) -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        // Fun√ß√£o Helper para disparar eventos de Pixel
        function pushDataLayer(eventName, params = {}) {
            const eventData = {
                'event': eventName,
                'ecommerce': params,
                'timestamp': new Date().toISOString()
            };
            window.dataLayer.push(eventData);
            console.log(`üì° Evento Disparado: ${eventName}`, params);
            // Se tiver pixel do Facebook instalado:
            if(typeof fbq === 'function') {
                fbq('track', eventName, params);
            }
        }
    </script>

    <style>
        /* === ESTILOS CORE OTIMIZADOS === */
        :root {
            --cor-whatsapp: #008069;
            --cor-whatsapp-light: #25D366;
            --bg-chat: #E5DDD5;
            --msg-in: #FFFFFF;
            --msg-out: #E7FFDB;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-chat);
            overscroll-behavior-y: none; /* Previne "bounce" no scroll */
        }
        
        /* Anti-Copy Classes */
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .no-drag { -webkit-user-drag: none; user-drag: none; pointer-events: none; }
        
        /* Background Pattern Otimizado (SVG Inline Base64) */
        .wa-bg { 
            background-color: var(--bg-chat);
            background-image: url("data:image/svg+xml,%3Csvg width='320' height='180' viewBox='0 0 320 180' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239CAFA3' fill-opacity='0.20' fill-rule='evenodd'%3E%3Ctext x='20' y='70' font-family='Arial, sans-serif' font-size='24' font-weight='bold' transform='rotate(-8 20 70)'%3Ewww.donaantonia.com.br%3C/text%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Bal√µes de Mensagem */
        .msg-in { background-color: var(--msg-in); border-radius: 0 8px 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg-out { background-color: var(--msg-out); border-radius: 8px 0 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        
        /* Bot√µes de A√ß√£o R√°pida */
        .msg-options { display: flex; flex-direction: column; gap: 8px; width: 85%; }
        .wa-btn {
            background-color: white; color: var(--cor-whatsapp); padding: 12px 16px; 
            border-radius: 8px; width: 100%; text-align: center; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); border: 1px solid #f0f0f0;
            cursor: pointer; transition: transform 0.1s, background-color 0.2s;
        }
        .wa-btn:active { background-color: #f0f2f5; transform: scale(0.98); }
        .wa-btn-title { font-weight: 600; font-size: 15px; display: block; }
        .wa-btn-subtitle { font-weight: 400; font-size: 11px; color: #667781; display: block; margin-top: 2px; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Anima√ß√£o Digitando */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Anima√ß√£o de Entrada */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* === COMPONENTES DO CARD DE PRODUTO === */
        .card-cesta-new {
            background: #fff; border-radius: 12px; border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column;
            max-width: 340px; width: 100%; margin-bottom: 5px;
        }

        .card-header-visual {
            display: flex; flex-direction: column; align-items: center; 
            background: #fff; border-bottom: 1px solid #f0f0f0; position: relative;
        }
        
        .card-title-row { width: 100%; padding: 12px 10px; background: #fdfdfd; text-align: center; border-bottom: 1px solid #f0f0f0; }
        .card-title-row h2 { font-size: 1.3rem; margin: 0; color: #0F2546; font-weight: 800; text-transform: uppercase; letter-spacing: -0.5px; }

        .card-img-large {
            width: 180px; height: 180px; object-fit: cover; border-radius: 8px; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15)); margin: 15px;
        }

        .selo-destaque {
            position: absolute; top: 45px; right: 10px;
            background: linear-gradient(135deg, #ffb300, #FFB300);
            color: #0F2546; padding: 4px 10px; border-radius: 20px;
            font-weight: 800; font-size: 0.7rem; text-transform: uppercase; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Slider Otimizado */
        .product-slider {
            display: flex; overflow-x: auto; gap: 10px; padding: 0 15px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .product-slide {
            flex: 0 0 120px; min-height: 160px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 5px;
            text-align: center;
        }
        .product-slide img { width: 85px; height: 85px; object-fit: contain; margin-bottom: 8px; }

        /* Widget de Pedido */
        .order-widget {
            background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--cor-whatsapp-light); margin-top: 5px; max-width: 340px;
        }
        
        .radio-arroz-option {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 15px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 8px;
            cursor: pointer; background: white; transition: all 0.2s;
        }
        .radio-arroz-option.selected { border-color: var(--cor-whatsapp-light); background: #f0fff4; }
        
        .btn-encomendar-card {
            width: 100%; background-color: var(--cor-whatsapp-light); color: white; border: none; padding: 14px;
            border-radius: 8px; font-size: 1rem; font-weight: 800; text-transform: uppercase;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 10px; box-shadow: 0 3px 0 #189d4b;
        }
        .btn-encomendar-card:active { transform: translateY(3px); box-shadow: none; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden no-select" oncontextmenu="return false;">

    <!-- HEADER: Elementos sem√¢nticos para SEO -->
    <header class="bg-[#008069] text-white p-3 flex items-center shadow-md z-30 shrink-0">
        <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden mr-3 border border-white/30 relative shrink-0">
            <!-- Imagem com prote√ß√£o contra arraste -->
            <img src="img/logo.png" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo&backgroundColor=c0aede'" alt="Atendente Osvaldo" class="w-full h-full object-cover no-drag" draggable="false">
            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
        </div>
        <div class="flex-1 min-w-0">
            <h1 class="font-bold text-lg leading-tight truncate">Osvaldo - Cestas</h1>
            <p id="status-text" class="text-xs text-green-100/80 truncate">Online</p>
        </div>
        <!-- Links Sociais com noopener noreferrer para seguran√ßa -->
        <div class="flex gap-4 text-xl shrink-0">
            <a href="https://instagram.com/cestas.dona.antonia.cuiaba.vg" target="_blank" rel="noopener noreferrer" class="text-white hover:text-gray-200"><i class="ph ph-instagram-logo"></i></a>
            <a href="https://wa.me/5565998150975" target="_blank" rel="noopener noreferrer" class="text-white hover:text-gray-200"><i class="ph ph-whatsapp-logo"></i></a>
        </div>
    </header>

    <!-- √ÅREA DE CHAT (MAIN) -->
    <main id="chat-container" class="wa-bg flex-1 overflow-y-auto p-4 space-y-3 relative scrolling-touch">
        <!-- As mensagens ser√£o injetadas via JS -->
    </main>

    <!-- INPUT AREA -->
    <footer id="input-footer" class="bg-[#F0F2F5] p-2 flex items-center gap-2 shrink-0 z-30 pb-safe">
        <div class="flex-1 bg-white rounded-full px-4 py-2 shadow-sm flex items-center">
            <input type="text" id="user-input" placeholder="Digite seu nome..." class="w-full outline-none text-base bg-transparent text-gray-800" autocomplete="off" autocapitalize="words">
        </div>
        <div id="send-btn" class="bg-[#008069] text-white rounded-full p-3 shadow-md cursor-pointer transition active:scale-95 flex items-center justify-center">
            <i class="ph-fill ph-paper-plane-right text-xl"></i>
        </div>
    </footer>

    <script>
        // === CONFIGURA√á√ïES & SEGURAN√áA ===
        const CONFIG = {
            ownerName: "Osvaldo",
            whatsAppNumber: "5565998150975",
            instagramLink: "https://instagram.com/cestas.dona.antonia.cuiaba.vg",
            officialDomain: "donaantonia.com.br" // Dom√≠nio para verifica√ß√£o de seguran√ßa
        };

        // SECURITY: Domain Lock (Anti-Clonagem)
        function securityCheck() {
            // Em produ√ß√£o, descomente as linhas abaixo para for√ßar o dom√≠nio correto
            /*
            if (window.location.hostname !== CONFIG.officialDomain && window.location.hostname !== 'localhost') {
                window.location.href = 'https://' + CONFIG.officialDomain;
            }
            */
            // Anti-Frame (evita clickjacking)
            if (window.self !== window.top) {
                window.top.location.href = window.self.location.href;
            }
        }
        securityCheck();

        // === CAT√ÅLOGO DE PRODUTOS ===
        const CESTAS = [
            {
                id: 'grande', 
                nome: 'Cesta Grande', 
                arrozQtd: 4, 
                brindeNome: '1 OMO 800g',
                brindeImg: 'img/limpezaehigiente/sab√£o em p√≥ omo 800g.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-grande.avif',
                items: ['4 Arroz Koblenz 5kg', '3 A√ß√∫car Doce Dia 2kg', '4 √ìleo de Soja Liza 900ml', '4 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 500g', '3 Espaguete QDelicia 500g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '2 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '4 Suco Frisco', '1 Sab√£o Barra Ype 900g', '2 Creme Dental Sorriso 70g', '2 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '4 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: 380.00 }, { arroz: 'Koblenz', preco: 390.00 }]
            },
            {
                id: 'media', 
                nome: 'Cesta M√©dia', 
                arrozQtd: 3, 
                brindeNome: '1 Caf√© 250g',
                brindeImg: 'img/alimento/cafe caboclo 250g.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-media.avif',
                items: ['3 Arroz Koblenz 5kg', '2 A√ß√∫car Doce Dia 2kg', '3 √ìleo de Soja Liza 900ml', '3 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 500g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '2 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '2 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '3 Suco Frisco', '1 Sab√£o Barra Ype 900g', '2 Creme Dental Sorriso 70g', '2 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '3 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: 320.00 }, { arroz: 'Koblenz', preco: 325.00 }]
            },
            {
                id: 'pequena', 
                nome: 'Cesta Pequena', 
                arrozQtd: 2, 
                brindeNome: '1 Amaciante 2L',
                brindeImg: 'img/limpezaehigiente/amaciante ype 2L.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-pequena.avif',
                items: ['2 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '2 √ìleo de Soja Liza 900ml', '2 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '1 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '2 Suco Frisco', '1 Sab√£o Barra Ype 900g', '1 Creme Dental Sorriso 70g', '1 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '2 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: 215.00 }, { arroz: 'Koblenz', preco: 220.00 }]
            },
            {
                id: 'mini', 
                nome: 'Cesta Mini', 
                arrozQtd: 1, 
                brindeNome: '1 Feij√£o 1kg',
                brindeImg: 'img/alimento/feij√£o da casa.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-mini.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '2 √ìleo de Soja Liza 900ml', '2 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '1 Espaguete QDelicia 500g', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Bolacha MyBit Recheada', '1 Miojo Apti', '2 Suco Frisco', '1 Sab√£o Barra Ype 900g', '1 Creme Dental Sorriso 70g', '1 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '1 Detergente Ype 500ml', '1 Qboa 1 Litro', '2 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: 165.00 }, { arroz: 'Koblenz', preco: 170.00 }]
            },
            {
                id: 'economica', 
                nome: 'Cesta Econ√¥mica', 
                destaque: 'Mais Vendida', 
                arrozQtd: 1, 
                brindeNome: '1 Trigo 1kg',
                brindeImg: 'img/alimento/trigo vitoriosa.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-economica.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '1 √ìleo de Soja Liza 900ml', '1 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '1 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Farinha Mandioca', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Bolacha MyBit Recheada', '1 Miojo Apti', '1 Suco Frisco'],
                opcoes: [{ arroz: 'Valor √önico', preco: 85.00 }]
            }
        ];

        // --- SISTEMA DE CHAT & CORE LOGIC ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');
        const inputFooter = document.getElementById('input-footer');

        let state = { 
            step: 0, 
            userName: '', 
            clientDisplayName: '', 
            viewedBaskets: [],
            timerRef: null,
            currentBasketId: null,
            suggestedIndex: null
        };

        const getGreeting = () => {
            const h = new Date().getHours();
            return h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        };

        const getCurrentTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        // Simula digita√ß√£o humana
        function addMessage(text, sender = 'bot', forceDelay = null) {
            return new Promise(resolve => {
                const typingTime = forceDelay !== null ? forceDelay : Math.min(800 + (text.length * 20), 3000);
                const preTypingDelay = sender === 'bot' ? 500 : 0;

                setTimeout(() => {
                    if (sender === 'bot') {
                        statusText.innerText = 'Digitando...';
                        scrollToBottom();

                        const typingId = `typing-${Date.now()}`;
                        const typingHTML = `
                            <div id="${typingId}" class="flex justify-start w-full mb-2">
                                <div class="msg-in p-3 px-4 rounded-lg relative">
                                    <div class="flex gap-1 text-gray-400">
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', typingHTML);
                        scrollToBottom();

                        setTimeout(() => {
                            const typingEl = document.getElementById(typingId);
                            if(typingEl) typingEl.remove();
                            
                            const isCard = text.includes('card-cesta-new') || text.includes('order-widget');
                            const bubbleClass = isCard ? 'p-0 bg-transparent shadow-none' : 'p-2 px-3 bg-white shadow-sm';
                            
                            const html = `
                                <div class="flex justify-start w-full mb-2 fade-in">
                                    <div class="msg-in ${bubbleClass} rounded-lg relative max-w-[95%] text-gray-800 text-[15px] leading-snug no-select">
                                        ${text}
                                        ${!isCard ? `<span class="block text-[10px] text-gray-400 text-right mt-1 -mr-1">${getCurrentTime()}</span>` : ''}
                                    </div>
                                </div>`;
                            chatContainer.insertAdjacentHTML('beforeend', html);
                            statusText.innerText = 'Online';
                            scrollToBottom();
                            resolve();
                        }, typingTime);
                    } else {
                        const html = `
                            <div class="flex justify-end w-full mb-2">
                                <div class="msg-out p-2 px-3 rounded-lg relative max-w-[85%] text-gray-800 text-[15px] leading-snug shadow-sm">
                                    ${text}
                                    <span class="block text-[10px] text-[#97a892] text-right mt-1 -mr-1">
                                        ${getCurrentTime()} <i class="ph-bold ph-checks text-blue-500 ml-1"></i>
                                    </span>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', html);
                        scrollToBottom();
                        resolve();
                    }
                }, preTypingDelay);
            });
        }

        // Renderiza bot√µes de op√ß√£o
        function showOptions(options) {
            setTimeout(() => {
                const optionsId = `opts-${Date.now()}`;
                let buttonsHTML = options.map(opt => `
                    <button onclick="handleOptionClick('${opt.text}', '${opt.value}', ${opt.nextStep}, '${optionsId}')" 
                            class="wa-btn text-left">
                        <span class="wa-btn-title">${opt.text}</span>
                        ${opt.subtext ? `<span class="wa-btn-subtitle">${opt.subtext}</span>` : ''}
                    </button>
                `).join('');

                const html = `
                    <div id="${optionsId}" class="flex justify-start w-full mb-2 fade-in">
                        <div class="msg-options">
                            ${buttonsHTML}
                        </div>
                    </div>`;
                chatContainer.insertAdjacentHTML('beforeend', html);
                scrollToBottom();
            }, 700);
        }

        // --- FUN√á√ïES DE NEG√ìCIO E RASTREAMENTO ---

        // Helper para imagens de produtos
        function getProductImage(text) {
            const lowerText = text.toLowerCase();
            let imgName = 'outros.png';
            let folder = 'img/alimento/';

            // Mapeamento simples de palavras-chave para imagens
            if(lowerText.includes('arroz')) imgName = 'Arroz Koblenz 5kg.webp';
            else if(lowerText.includes('a√ß√∫car') || lowerText.includes('acucar')) imgName = 'a√ßucar doce dia 2 kg.webp';
            else if(lowerText.includes('caf√©') || lowerText.includes('cafe')) imgName = lowerText.includes('500g') ? 'cafe caboclo 500g.webp' : 'cafe caboclo 250g.webp';
            else if(lowerText.includes('feij√£o')) imgName = 'feij√£o da casa.webp';
            else if(lowerText.includes('oleo') || lowerText.includes('√≥leo')) imgName = 'oleo de soja liza.webp';
            else if(lowerText.includes('trigo')) imgName = 'trigo vitoriosa.webp';
            else if(lowerText.includes('macarr√£o') || lowerText.includes('espaguete')) imgName = 'espaguete qdelicia.webp';
            else if(lowerText.includes('sab√£o em p√≥')) { imgName = 'sab√£o em p√≥ omo 800g.webp'; folder = 'img/limpezaehigiente/'; }
            else if(lowerText.includes('detergente')) { imgName = 'Detergente Ype 500ml.webp'; folder = 'img/limpezaehigiente/'; }
            else if(lowerText.includes('amaciante')) { imgName = 'amaciante ype 2L.webp'; folder = 'img/limpezaehigiente/'; }
            else if(lowerText.includes('qboa')) { imgName = 'Qboa 1 Litro.webp'; folder = 'img/limpezaehigiente/'; }

            return `${folder}${imgName}`;
        }

        function parseProductItem(text) {
            const match = text.match(/^(\d+)\s+(.*)$/);
            if(match) {
                const qty = parseInt(match[1]);
                return { qty: qty > 1 ? `${qty} unid` : `${qty} unid`, name: match[2], img: getProductImage(match[2]) }; 
            }
            return { qty: '1 unid', name: text, img: getProductImage(text) };
        }

        // Geradores de HTML dos Cards
        function generateCardHTML(cesta) {
            // SEO: Usar alt tags descritivas
            const slidesHTML = cesta.items.map(item => {
                const parsed = parseProductItem(item);
                const fallbackImg = `https://placehold.co/80x80/eee/999?text=${parsed.name.substring(0,3).toUpperCase()}`;
                return `
                <div class="product-slide">
                    <img src="${parsed.img}" loading="lazy" decoding="async" onerror="this.src='${fallbackImg}'" alt="${parsed.name}" class="no-drag">
                    <div style="display:flex; flex-direction:column; line-height:1.1;">
                        <span style="font-size:0.85rem; font-weight:800; color:#0d5f46; margin-bottom:3px;">${parsed.qty}</span>
                        <span style="font-size:0.75rem; color:#444; font-weight:600; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${parsed.name}</span>
                    </div>
                </div>`;
            }).join('');
            
            const pricesHTML = cesta.opcoes.map(opt => `
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:4px; color:#555;">
                    <span>${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                    <strong style="color:#ff5252;">R$ ${opt.preco.toFixed(2).replace('.', ',')}</strong>
                </div>
            `).join('');

            return `
            <div class="card-cesta-new">
                <div class="card-header-visual">
                    <div class="card-title-row">
                        <h2>${cesta.nome}</h2>
                    </div>
                    ${cesta.destaque ? `<div class="selo-destaque">${cesta.destaque}</div>` : ''}
                    <img src="${cesta.img}" class="card-img-large no-drag" alt="Foto da ${cesta.nome}">
                </div>
                
                <div style="background:#f9fafb; padding:15px 0; position:relative;">
                    <div class="product-slider">
                        ${slidesHTML}
                        <div style="min-width:15px;"></div>
                    </div>
                    <div style="position:absolute; right:5px; top:50%; transform:translateY(-50%); pointer-events:none; opacity:0.8;">
                         <i class="ph-bold ph-caret-right text-green-600 text-2xl animate-pulse"></i>
                    </div>
                </div>

                <div style="padding:10px 15px; background:#fff; border-top:1px solid #eee;">
                    ${pricesHTML}
                </div>
            </div>`;
        }

        function generateOrderWidget(cesta) {
            const riceOptionsHTML = cesta.opcoes.map(opt => `
                <div class="radio-arroz-option" onclick="selectRice('${cesta.id}', '${opt.arroz}', ${opt.preco})">
                    <div style="display:flex; justify-content:space-between; width:100%; padding-right:10px;">
                        <span style="font-weight:600; font-size:0.9rem; color:#333;">${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                        <span style="color:#ff5252; font-weight:800; font-size:1rem;">R$ ${opt.preco.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                         <div class="w-3 h-3 bg-green-500 rounded-full hidden selection-dot"></div>
                    </div>
                </div>
            `).join('');

            return `
            <div id="widget-${cesta.id}" class="order-widget">
                <h3 style="font-size:1rem; font-weight:700; color:#0F2546; margin-bottom:10px; text-align:center;">Finalize seu pedido da ${cesta.nome}:</h3>
                <p style="margin-bottom:10px; font-size:0.85rem; color:#666; text-align:center;">Escolha o arroz abaixo:</p>
                ${riceOptionsHTML}
                <button id="btn-pedir-${cesta.id}" class="btn-encomendar-card text-sm">
                    <i class="fa-brands fa-whatsapp"></i> Escolha o Arroz
                </button>
            </div>`;
        }

        // --- INTERA√á√ïES DO USU√ÅRIO ---
        
        window.selectRice = function(id, nomeArroz, preco) {
            const btn = document.getElementById(`btn-pedir-${id}`);
            const allOpts = document.querySelectorAll(`#widget-${id} .radio-arroz-option`);
            
            // Visual Update
            allOpts.forEach(el => {
                el.classList.remove('selected');
                el.querySelector('.selection-dot').classList.add('hidden');
            });
            event.currentTarget.classList.add('selected');
            event.currentTarget.querySelector('.selection-dot').classList.remove('hidden');

            // META ADS: Dispara AddToCart quando o usu√°rio seleciona o produto
            pushDataLayer('AddToCart', {
                currency: "BRL",
                value: preco,
                items: [{ item_id: id, item_name: `Cesta ${id} - ${nomeArroz}`, price: preco }]
            });

            btn.innerHTML = `<i class="fa-brands fa-whatsapp"></i> PEDIR AGORA`;
            btn.onclick = () => {
                // META ADS: InitiateCheckout ao clicar no bot√£o final
                pushDataLayer('InitiateCheckout', {
                    currency: "BRL",
                    value: preco,
                    items: [{ item_id: id, item_name: `Cesta ${id} - ${nomeArroz}` }]
                });

                const msg = `Ol√°! Aqui √© o ${state.clientDisplayName}. Quero encomendar a *Cesta ${id.toUpperCase()}* com *Arroz ${nomeArroz}* por *R$ ${preco.toFixed(2)}*.`;
                const link = `https://wa.me/${CONFIG.whatsAppNumber}?text=${encodeURIComponent(msg)}`;
                
                // Redirecionamento seguro
                setTimeout(() => { window.open(link, '_blank'); }, 300);
                
                handlePostClick();
            }
        };

        function handlePostClick() {
            setTimeout(() => {
                state.step = 100;
                nextStepFlow();
            }, 1500);
        }

        // --- M√ÅQUINA DE ESTADOS DO CHAT ---

        window.onload = async () => {
            // Check inicial de seguran√ßa
            if (window.self !== window.top) return;

            setTimeout(async () => {
                await addMessage(`${getGreeting()}! Tudo bem? üëã`, 'bot', 1000);
                await addMessage(`Aqui √© o <b>${CONFIG.ownerName}</b>, da Cesta B√°sica Econ√¥mica.`, 'bot', 1500);
                await addMessage(`Qual √© o seu primeiro nome?`, 'bot', 1200);
                userInput.focus();
            }, 500);
        };

        async function handleInput() {
            const text = userInput.value.trim();
            if (!text) return;

            if (state.step === 0) {
                const parts = text.split(/\s+/);
                state.userName = parts[0]; 
                state.clientDisplayName = parts.slice(0, 2).join(' ');

                // META ADS: Lead (Potencial)
                pushDataLayer('Lead', { user_name: state.userName });

                state.step = 1;
                userInput.value = '';
                await addMessage(text, 'user');
                inputFooter.style.display = 'none'; // Esconde input para focar nas op√ß√µes
                
                nextStepFlow();
            }
        }

        async function handleOptionClick(text, value, nextStep, containerId) {
            const container = document.getElementById(containerId);
            if(container) container.style.opacity = '0.5'; // Feedback visual de desabilitado

            await addMessage(text, 'user');
            state.step = nextStep;

            if (state.step === 5 && value.startsWith('select_cesta_')) {
                state.suggestedIndex = parseInt(value.split('_')[2]);
            }

            if (value === 'menu_cestas' || value === 'ver_outra') {
                state.step = 4; 
                nextStepFlow('loop_cestas'); 
                return; 
            }

            if (value === 'salvar_brinde') {
                pushDataLayer('Contact', { method: 'whatsapp_brinde' });
                window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=Ol√°! Aqui √© o ${state.clientDisplayName}. Salvei seu contato e quero garantir meu brinde!`, '_blank');
                handlePostClick();
            }

            nextStepFlow(value);
        }

        async function nextStepFlow(triggerValue) {
            const name = state.userName;
            if(state.timerRef) clearTimeout(state.timerRef);

            switch (state.step) {
                case 1: 
                    await addMessage(`Prazer, ${name}! üòÄ`);
                    await addMessage(`Voc√™ j√° conhece a Dona Ant√¥nia Alimentos?`);
                    showOptions([
                        { text: "Sim, j√° conhe√ßo üëç", value: "sim", nextStep: 3 },
                        { text: "N√£o conhe√ßo ü§î", value: "nao", nextStep: 2 }
                    ]);
                    break;

                case 2: // Prova Social / Autoridade
                    await addMessage(`Somos de Cuiab√°, com 8 anos de tradi√ß√£o entregando qualidade na sua mesa.`);
                    // Em produ√ß√£o, isso seria um slide de fotos da empresa
                    await addMessage(`Temos loja f√≠sica e estoque pr√≥prio para garantir sua entrega r√°pida.`);
                    setTimeout(() => { state.step = 3; nextStepFlow(); }, 3500);
                    break;

                case 3: 
                    await addMessage(`Vou te mostrar as nossas cestas pra voc√™ conhecer.`);
                    showOptions([{ text: "OK, mostrar cestas", value: "ok", nextStep: 4 }]);
                    break;

                case 4: // Menu Principal
                    if (triggerValue === 'loop_cestas') await addMessage(`D√° uma olhada nas outras op√ß√µes üëá`);
                    
                    let opcoesCestas = CESTAS.map((c, i) => ({
                        text: c.nome,
                        subtext: `(${c.arrozQtd} pacotes de arroz)`,
                        value: `select_cesta_${i}`,
                        nextStep: 5 
                    }));

                    opcoesCestas.push({ text: "Formas de Pagamento üí≥", subtext: "Ver como pagar", value: "pagamento", nextStep: 6 });
                    showOptions(opcoesCestas);
                    break;

                case 5: // Exibe Produto & Loop de Reten√ß√£o
                    const index = state.suggestedIndex !== null ? state.suggestedIndex : 0; 
                    const cesta = CESTAS[index];
                    state.currentBasketId = cesta.id;

                    // Adiciona aos visualizados se ainda n√£o estiver
                    if(!state.viewedBaskets.includes(cesta.id)) state.viewedBaskets.push(cesta.id);

                    // META ADS: ViewContent
                    pushDataLayer('ViewContent', {
                        content_ids: [cesta.id],
                        content_name: cesta.nome,
                        content_type: 'product',
                        currency: 'BRL',
                        value: cesta.opcoes[0].preco
                    });

                    await addMessage(`Essa √© a <b>${cesta.nome}</b>:`);
                    await addMessage(generateCardHTML(cesta));
                    
                    // Delay para mostrar o Widget de Pedido
                    setTimeout(async () => {
                         await addMessage(generateOrderWidget(cesta));
                    }, 1500);

                    // --- NOVA L√ìGICA DE RETEN√á√ÉO (15s) ---
                    state.timerRef = setTimeout(async () => {
                        // Verifica se o usu√°rio ainda est√° nesta etapa (n√£o clicou em nada)
                        if(state.step === 5) {
                            
                            // Filtra cestas N√ÉO visualizadas (exceto a atual)
                            const unviewed = CESTAS.filter(c => !state.viewedBaskets.includes(c.id) && c.id !== state.currentBasketId);
                            // Se o usu√°rio j√° viu todas, mostra todas as outras exceto a atual
                            const remaining = unviewed.length > 0 ? unviewed : CESTAS.filter(c => c.id !== state.currentBasketId);

                            if (remaining.length > 0) {
                                await addMessage(`Tenho outras op√ß√µes que podem te interessar:`, 'bot');
                                
                                // Mapeia para encontrar o √≠ndice original correto
                                const opts = remaining.map(c => {
                                    const originalIndex = CESTAS.findIndex(original => original.id === c.id);
                                    return {
                                        text: c.nome,
                                        subtext: `(${c.arrozQtd} pacotes de arroz)`,
                                        value: `select_cesta_${originalIndex}`,
                                        nextStep: 5
                                    };
                                });
                                showOptions(opts);

                                // Bot√£o de Pagamento Separado (1.5s depois)
                                setTimeout(() => {
                                     if(state.step !== 5) return; 
                                     showOptions([{ text: "Ver Formas de Pagamento üí≥", value: "pagamento", nextStep: 6 }]);
                                }, 1500);
                            }
                        }
                    }, 15000); // 15 segundos
                    break;

                case 6: // Obje√ß√£o de Pagamento
                    await addMessage(`Facilitamos o pagamento pra voc√™:`);
                    const listaPagamento = `
                        <ul class="list-disc pl-5 space-y-1">
                            <li><b>Cart√£o de Cr√©dito/D√©bito</b></li>
                            <li><b>PIX</b> ou <b>Dinheiro</b> na entrega</li>
                            <li><b>Vale Alimenta√ß√£o:</b> Alelo, Sodexo, Pluxee, Caju...</li>
                            <li class="text-red-500 font-bold">N√£o vendemos pra 30 dias</li>
                        </ul>`;
                    await addMessage(listaPagamento);
                    await addMessage(`E o melhor: Voc√™ s√≥ paga quando recebe a cesta! üè†`);
                    
                    // Reorganizado: Convers√£o primeiro, Ver Cestas por √∫ltimo
                    showOptions([
                        { text: "Entrar no Grupo VIP üöÄ", subtext: "Ofertas rel√¢mpago", value: "vip", nextStep: 99 },
                        { text: "Ver as Cestas Novamente üõí", value: "menu_cestas", nextStep: 4 }
                    ]);
                    break;

                case 99: // Link Externo
                    if(triggerValue === 'vip') {
                        pushDataLayer('CompleteRegistration', { content_name: 'Grupo VIP' });
                        window.open("https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1", '_blank');
                        handlePostClick();
                    }
                    break;

                case 100: // Fim
                    await addMessage(`Obrigado, ${name}! Estamos te aguardando no WhatsApp. üü¢`);
                    break;
            }
        }

        sendBtn.addEventListener('click', handleInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleInput();
        });
    </script>
</body>
</html>
