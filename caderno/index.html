<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caderno Digital Pessoal</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o r√°pida e moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos globais para layout iOS/Apple (desktop-like) */
        body {
            /* Prioriza a fonte do sistema iOS/macOS e fallback para Inter */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Inter', sans-serif;
            background-color: #f0f2f5; 
            color: #1c1c1e; 
        }
        
        /* Estilo base para pain√©is/cart√µes no estilo iOS */
        .ios-panel {
            background-color: #ffffff; 
            border-radius: 16px; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); 
            border: 1px solid rgba(220, 220, 220, 0.5); 
            transition: all 0.2s;
        }

        /* Inputs e Bot√µes */
        .ios-input { border-radius: 10px; background-color: #f7f7f7; border: 1px solid #d1d1d6; padding: 8px 12px; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); }
        .ios-input:focus { border-color: #007aff; outline: none; }
        .ios-button-primary { background-color: #007aff; color: white; border-radius: 12px; font-weight: 600; padding: 10px 16px; transition: background-color 0.15s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .ios-button-primary:hover { background-color: #005fcc; }
        .ios-button-secondary { background-color: #e5e5ea; color: #1c1c1e; border-radius: 12px; font-weight: 500; padding: 10px 16px; transition: background-color 0.15s; }
        .ios-button-secondary:hover { background-color: #d1d1d6; }
        .note-card-ios { background-color: #ffffff; border-radius: 10px; border: 1px solid #e0e0e0; }
        .note-card-ios:hover { background-color: #f0f0f5; }

        /* Scrollbars (Ocultar) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Layout do Editor */
        .editor-scroll-container { height: 100%; overflow-y: auto; }

        /* Barra de Ferramentas Fixa (STICKY) */
        #fixedToolbar {
            position: sticky;
            top: 0; 
            z-index: 20;
            background-color: #ffffff; 
            padding: 10px 24px; 
            margin: -24px -24px 0 -24px;
            border-bottom: 1px solid #f0f0f5;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        
        /* Placeholder para contenteditable */
        #noteContent {
            line-height: 1.6;
            min-height: 400px;
            padding: 12px 0;
            border: none;
            background-color: transparent;
        }
        #noteContent:empty:before {
            content: attr(placeholder);
            color: #9ca3af; 
        }
        
        /* Bot√£o IA Inativo */
        .ia-button-inactive {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none; 
        }

        /* --- ESTILOS DE IMPRESS√ÉO (CORRIGIDO) --- */
        @media print {
            /* Oculta colunas de navega√ß√£o/lista */
            .w-1\/5 { display: none !important; }

            /* Faz a coluna do editor ocupar 100% da p√°gina */
            .w-3\/5 { 
                width: 100% !important;
                min-height: 100vh;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
                /* Impede o corte do conte√∫do longo */
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Oculta barras de ferramentas e placeholders */
            #fixedToolbar, #editorPlaceholder { display: none !important; }

            /* Garante que o conte√∫do e o t√≠tulo da nota sejam impressos */
            #noteContent, #noteTitle, .note-header-info, .editor-scroll-container {
                background: none !important;
                color: #000 !important;
                box-shadow: none !important;
                border: none !important;
                /* Essencial: for√ßar a renderiza√ß√£o do conte√∫do completo */
                overflow: visible !important;
                height: auto !important;
                min-height: auto !important;
                padding: 0 10px; /* Padding para margens de impress√£o */
            }

            /* Reseta o layout principal para que o conte√∫do preencha a p√°gina */
            body > div.flex {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body>

    <!-- Layout Principal: 3 Colunas (Estilo iOS) -->
    <div class="flex h-screen p-4 space-x-4 overflow-hidden">
        
        <!-- Coluna de Navega√ß√£o/Filtros (Sidebar) - LARGURA 20% -->
        <div class="w-1/5 ios-panel p-4 overflow-y-auto no-scrollbar">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Filtros & Categorias</h2>
            
            <button id="newNoteBtn" class="w-full ios-button-primary mb-4">
                + Nova Nota
            </button>
            
            <div class="mb-6">
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoria</label>
                <select id="categoryFilter" class="w-full ios-input text-sm">
                    <option value="">Todas as Categorias</option>
                    <!-- Op√ß√µes de categorias ser√£o preenchidas via JS -->
                </select>
            </div>
            
            <div class="mb-6">
                <label for="dateSearch" class="block text-sm font-medium text-gray-700 mb-1">Buscar por Data (In√≠cio)</label>
                <input type="date" id="dateSearch" class="w-full ios-input text-sm">
                <p class="text-xs text-gray-500 mt-1">Busca notas criadas a partir desta data.</p>
            </div>
            
            <!-- Gest√£o de Dados -->
            <div class="mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Gest√£o de Dados</h3>
                <button id="exportBtn" class="w-full ios-button-secondary text-sm mb-2">
                    Exportar Notas (JSON)
                </button>
                <label for="importFile" class="w-full block text-center ios-button-secondary cursor-pointer text-sm">
                    Importar Notas (JSON)
                </label>
                <!-- Campo de input de ficheiro escondido -->
                <input type="file" id="importFile" accept=".json" class="hidden">
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500">
                    <span class="font-semibold text-gray-700">Armazenamento Local.</span>
                </p>
                <p class="text-xs text-gray-500 mt-2">
                    As suas notas s√£o salvas no seu navegador.
                </p>
            </div>
        </div>

        <!-- Coluna da Lista de Notas - LARGURA 20% -->
        <div class="w-1/5 ios-panel p-4 overflow-y-auto no-scrollbar">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Minhas Notas</h2>
            <div id="notesList" class="space-y-3">
                <!-- Notas ser√£o carregadas aqui -->
                <p class="text-center text-gray-500" id="listPlaceholder">Nenhuma nota ainda. Crie uma!</p>
            </div>
        </div>

        <!-- Coluna do Editor/Visualizador de Notas - LARGURA 60% -->
        <div class="w-3/5 ios-panel p-6 relative">
            <div id="editorPlaceholder" class="flex items-center justify-center h-full text-gray-400 text-lg">
                Selecione uma nota ou crie uma nova para come√ßar a escrever.
            </div>

            <div id="noteEditor" class="h-full flex flex-col hidden">
                
                <!-- Barra de Ferramentas Fixa (STICKY) -->
                <div id="fixedToolbar" class="flex flex-wrap items-center justify-between">
                    
                    <!-- 1. Controles de Edi√ß√£o e Categoria (Esquerda) -->
                    <div class="flex space-x-3 items-center">
                        
                        <!-- Seletor de Categoria -->
                        <select id="noteCategory" class="ios-input text-sm p-1 max-w-[120px]">
                            <option value="Geral">Geral</option>
                            <option value="Ideias">Ideias</option>
                            <option value="Trabalho">Trabalho</option>
                            <option value="Pessoal">Pessoal</option>
                            <!-- Categorias do JS ser√£o adicionadas aqui -->
                        </select>

                        <!-- Bot√£o IA (Foguete) -->
                         <button id="iaFloatingButton" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white text-base font-semibold py-1 px-2 rounded-full shadow-lg transition duration-150 transform hover:scale-105 ia-button-inactive"
                            title="Enviar texto selecionado para o Google IA (udm=50)">
                            üöÄ
                        </button>
                    </div>

                    <!-- 2. Bot√µes de A√ß√£o (Direita) -->
                    <div class="flex space-x-2 items-center">
                        <!-- Bot√£o Imprimir -->
                        <button id="printBtn" class="ios-button-secondary font-normal py-1 px-3 rounded-lg text-sm" title="Imprimir Nota">
                            &#x2399; <!-- √çcone de impressora ou similar -->
                        </button>

                        <button id="cancelEditBtn" class="ios-button-secondary font-normal py-1 px-3 rounded-lg text-sm">
                            Cancelar
                        </button>
                        <button id="deleteNoteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm hidden">
                            Excluir
                        </button>
                        <button id="saveNoteBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-sm">
                            Guardar
                        </button>
                    </div>
                </div> <!-- Fim #fixedToolbar -->
                
                <!-- Container de Rolagem (com o conte√∫do que rola) -->
                <div class="editor-scroll-container">
                    
                    <!-- T√≠tulo e Data (AGORA DENTRO DO SCROLL CONTAINER) -->
                    <div class="note-header-info">
                        <input type="text" id="noteTitle" placeholder="T√≠tulo da Nota" class="w-full text-2xl font-bold mb-2 ios-input border-none bg-transparent shadow-none p-0 focus:border-none focus:ring-0">
                        <p id="noteDate" class="text-sm text-gray-500 mb-4"></p>
                    </div>
                    
                    <!-- CONTE√öDO DA NOTA - Contenteditable Simples (Aceita HTML/formata√ß√£o de cola) -->
                    <div id="noteContent" 
                        contenteditable="true" 
                        placeholder="Comece a escrever a sua nota aqui... (Cole texto formatado ou selecione texto para usar a funcionalidade de IA!)" 
                        class="w-full ios-input overflow-y-auto border-none shadow-none bg-transparent">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts da L√≥gica da Aplica√ß√£o -->
    <script type="module">
        
        // --- Constantes e Vari√°veis de Configura√ß√£o ---
        
        const LOCAL_STORAGE_KEY = 'notebook_personal_notes';
        const IA_PROMPT = "Analise e explique este conceito: "; 
        const DEFAULT_CATEGORIES = ["Geral", "Ideias", "Trabalho", "Pessoal", "Estudo", "Rascunho"];

        let allNotes = [];
        let currentNoteId = null;

        // --- Fun√ß√µes de Persist√™ncia e UI B√°sica ---

        const loadNotesFromLocalStorage = () => {
            try {
                const storedNotes = localStorage.getItem(LOCAL_STORAGE_KEY);
                allNotes = storedNotes ? JSON.parse(storedNotes) : [];
            } catch (error) {
                console.error("Erro ao carregar notas do LocalStorage:", error);
                allNotes = [];
            }
        };

        const saveNotesToLocalStorage = () => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allNotes));
            } catch (error) {
                console.error("Erro ao salvar notas no LocalStorage:", error);
            }
        };

        const alertMessage = (message, color) => {
             console.log(`[Mensagem ${color.toUpperCase()}]: ${message}`);
             // Fun√ß√£o simplificada de feedback no console
        };

        const confirmAction = (message) => window.confirm(message); 

        const formatDate = (timestamp) => {
            if (timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('pt-PT', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
            }
            return new Date().toLocaleDateString('pt-PT');
        };
        
        const populateCategories = () => {
            const filterEl = document.getElementById('categoryFilter');
            const editorEl = document.getElementById('noteCategory');
            
            filterEl.innerHTML = '<option value="">Todas as Categorias</option>';
            editorEl.innerHTML = ''; 

            DEFAULT_CATEGORIES.forEach(cat => {
                const optFilter = document.createElement('option');
                optFilter.value = optFilter.textContent = cat;
                filterEl.appendChild(optFilter);

                const optEditor = document.createElement('option');
                optEditor.value = optEditor.textContent = cat;
                editorEl.appendChild(optEditor);
            });
        };

        // --- L√≥gica do Editor ---

        const resetEditor = () => {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').innerHTML = ''; 
            document.getElementById('noteCategory').value = 'Geral';
            document.getElementById('noteDate').textContent = 'Nova Nota (n√£o gravada)';
            document.getElementById('deleteNoteBtn').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('noteEditor').classList.remove('hidden');
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
            renderNotes();
        };

        const loadNoteToEditor = (note) => {
            currentNoteId = note.id;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').innerHTML = note.content;
            document.getElementById('noteCategory').value = note.category || 'Geral';
            document.getElementById('noteDate').textContent = `Criada em: ${formatDate(note.createdAt)}`;
            document.getElementById('deleteNoteBtn').classList.remove('hidden');
            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('noteEditor').classList.remove('hidden');
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
        };

        const saveNote = () => {
            const title = document.getElementById('noteTitle').value.trim() || 'Nota Sem T√≠tulo';
            const content = document.getElementById('noteContent').innerHTML.trim(); 
            const category = document.getElementById('noteCategory').value;
            const textContent = content.replace(/<[^>]*>/g, '').trim();

            if (!textContent) {
                alertMessage("O conte√∫do da nota n√£o pode estar vazio!", 'red');
                return;
            }

            const now = Date.now();
            
            if (currentNoteId) {
                const index = allNotes.findIndex(n => n.id === currentNoteId);
                if (index !== -1) {
                    allNotes[index] = {
                        ...allNotes[index],
                        title: title,
                        content: content,
                        category: category,
                        updatedAt: now,
                    };
                }
                alertMessage("Nota atualizada com sucesso!", 'green');
            } else {
                const newNote = {
                    id: crypto.randomUUID(),
                    title: title,
                    content: content,
                    category: category,
                    createdAt: now,
                    updatedAt: now,
                };
                allNotes.push(newNote);
                currentNoteId = newNote.id;
                alertMessage("Nota criada com sucesso!", 'green');
            }

            saveNotesToLocalStorage();
            renderNotes();
        };

        const deleteNote = () => {
            if (!currentNoteId) return;

            if (!confirmAction("Tem certeza que deseja excluir esta nota? Esta a√ß√£o √© irrevers√≠vel.")) {
                return;
            }

            allNotes = allNotes.filter(n => n.id !== currentNoteId);
            saveNotesToLocalStorage();
            
            resetEditor();
            document.getElementById('noteEditor').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.remove('hidden');
            
            alertMessage("Nota exclu√≠da com sucesso!", 'yellow');
            renderNotes();
        };
        
        // --- Fun√ß√µes IA e Impress√£o (CRITICAMENTE CORRIGIDAS) ---

        /**
         * Verifica a sele√ß√£o de texto dentro do editor e ativa/desativa o bot√£o IA.
         * Esta fun√ß√£o √© robusta para contenteditable.
         */
        const checkSelection = () => {
            const iaButton = document.getElementById('iaFloatingButton');
            const selection = window.getSelection();
            const selectedTextLength = selection.toString().trim().length;
            const editor = document.getElementById('noteContent');

            // 1. Deve haver texto selecionado.
            // 2. O n√≥ √¢ncora (in√≠cio da sele√ß√£o) deve estar dentro do div do editor.
            const isSelectionInEditor = selectedTextLength > 0 && editor.contains(selection.anchorNode);
            
            if (isSelectionInEditor) {
                iaButton.classList.remove('ia-button-inactive');
            } else {
                iaButton.classList.add('ia-button-inactive');
            }
        };

        /**
         * Executa a pesquisa de IA no Google.
         */
        const handleIaSearch = () => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText) {
                alertMessage("Selecione um texto antes de usar a IA.", 'yellow');
                return;
            }
            
            const query = IA_PROMPT + selectedText;
            const encodedQuery = encodeURIComponent(query);
            
            const googleUrl = `https://www.google.com/search?udm=50&q=${encodedQuery}`;
            
            window.open(googleUrl, '_blank');
            
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
            selection.removeAllRanges(); // Limpa a sele√ß√£o
        };

        /**
         * Inicia o processo de impress√£o da nota atual.
         */
        const handlePrint = () => {
            // O CSS de impress√£o (@media print) garante que apenas o editor seja vis√≠vel e
            // que o conte√∫do longo n√£o seja cortado.
            window.print();
        };
        
        // --- Fun√ß√µes de Renderiza√ß√£o e Export/Import (Inalteradas) ---
        
        const renderNotes = () => {
            const listEl = document.getElementById('notesList');
            const categoryFilter = document.getElementById('categoryFilter').value;
            const dateSearch = document.getElementById('dateSearch').value;
            
            listEl.innerHTML = '';

            let filteredNotes = allNotes;

            if (categoryFilter) {
                filteredNotes = filteredNotes.filter(note => note.category === categoryFilter);
            }

            if (dateSearch) {
                const searchDate = new Date(dateSearch);
                searchDate.setHours(0, 0, 0, 0);
                const searchTimestamp = searchDate.getTime();

                filteredNotes = filteredNotes.filter(note => {
                    return note.createdAt && note.createdAt >= searchTimestamp;
                });
            }
            
            if (filteredNotes.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500">Nenhuma nota encontrada.</p>`;
                if (allNotes.length === 0) {
                    document.getElementById('listPlaceholder').textContent = 'Nenhuma nota ainda. Crie uma!';
                }
                return;
            }

            filteredNotes.sort((a, b) => b.createdAt - a.createdAt);

            filteredNotes.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.className = `p-3 note-card-ios cursor-pointer transition duration-150 shadow-md ${note.id === currentNoteId ? 'ring-2 ring-indigo-500' : ''}`;
                
                const previewText = note.content.replace(/<[^>]*>/g, '').substring(0, 100).trim();

                noteCard.innerHTML = `
                    <h3 class="text-base font-semibold truncate text-gray-800">${note.title || 'Nota Sem T√≠tulo'}</h3>
                    <p class="text-xs text-gray-500 mt-1">
                        ${note.category} ‚Ä¢ ${formatDate(note.createdAt)}
                    </p>
                    <p class="text-sm text-gray-600 mt-2 line-clamp-2">${previewText}...</p>
                `;
                noteCard.onclick = () => {
                    loadNoteToEditor(note);
                    renderNotes(); 
                };
                listEl.appendChild(noteCard);
            });

            document.getElementById('listPlaceholder').textContent = allNotes.length === 0 ? 'Nenhuma nota ainda. Crie uma!' : '';
        };

        const handleExport = () => {
            if (allNotes.length === 0) { alertMessage("N√£o h√° notas para exportar.", 'yellow'); return; }
            const dataStr = JSON.stringify(allNotes, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.download = `caderno_notas_export_${date}.json`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alertMessage(`Exporta√ß√£o de ${allNotes.length} notas conclu√≠da!`, 'green');
        };

        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirmAction("Importar substituir√° todas as notas existentes. Tem certeza que deseja continuar?")) {
                event.target.value = null; 
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (!Array.isArray(importedNotes) || importedNotes.some(n => !n.id || !n.content)) {
                        throw new Error("Formato de ficheiro JSON inv√°lido para notas.");
                    }
                    allNotes = importedNotes; 
                    saveNotesToLocalStorage();
                    renderNotes();
                    alertMessage(`Importa√ß√£o de ${importedNotes.length} notas conclu√≠da com sucesso!`, 'green');
                } catch (error) {
                    console.error("Erro ao processar ficheiro de importa√ß√£o:", error);
                    alertMessage("Erro na importa√ß√£o. Ficheiro corrompido ou formato inv√°lido.", 'red');
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        };

        // --- Inicializa√ß√£o e Event Listeners ---

        const initializeApp = () => {
            loadNotesFromLocalStorage();
            populateCategories();
            renderNotes();

            // FIX CR√çTICO: Atacha os listeners de sele√ß√£o de forma robusta ao elemento
            const noteContentEl = document.getElementById('noteContent');
            if (noteContentEl) {
                noteContentEl.addEventListener('mouseup', checkSelection);
                noteContentEl.addEventListener('keyup', checkSelection);
                // Garante que o estado seja verificado mesmo ao perder o foco (ex: clique fora)
                noteContentEl.addEventListener('blur', () => setTimeout(checkSelection, 100));
            }
            
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
            
            // Adiciona Listeners de A√ß√£o
            document.getElementById('newNoteBtn').addEventListener('click', resetEditor);
            document.getElementById('saveNoteBtn').addEventListener('click', saveNote);
            document.getElementById('deleteNoteBtn').addEventListener('click', deleteNote);
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                currentNoteId = null;
                document.getElementById('noteEditor').classList.add('hidden');
                document.getElementById('editorPlaceholder').classList.remove('hidden');
                renderNotes();
            });

            // Listeners de Filtro
            document.getElementById('categoryFilter').addEventListener('change', renderNotes);
            document.getElementById('dateSearch').addEventListener('change', renderNotes);
            
            // Listeners de A√ß√µes
            document.getElementById('iaFloatingButton').addEventListener('click', handleIaSearch);
            document.getElementById('printBtn').addEventListener('click', (e) => { e.preventDefault(); handlePrint(); });
            document.getElementById('exportBtn').addEventListener('click', handleExport);
            document.getElementById('importFile').addEventListener('change', handleImport);
        };

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
