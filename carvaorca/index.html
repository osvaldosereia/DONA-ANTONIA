<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Carvalima - 06/01/2026</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* Otimiza√ß√µes Espec√≠ficas */
        body { --spacing: 0.5rem; font-size: 0.95rem; }
        header { padding-bottom: 0; border-bottom: 1px solid #e5e5e5; margin-bottom: 1rem; }
        hgroup h2 { font-weight: 300; color: #555; }
        
        /* Tabela Compacta */
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 0.5rem; vertical-align: middle; }
        input[type="text"], input[type="number"] { margin-bottom: 0; height: 2rem; font-size: 0.9rem; }
        button { cursor: pointer; }
        
        /* Utilit√°rios */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .text-red { color: #c92a2a; }
        .text-green { color: #2b8a3e; }
        .w-small { width: 70px; }
        .w-med { width: 100px; }
        
        /* Totais */
        .summary-card { background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: right; }
        
        /* Estilos de Impress√£o */
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            table { border: 1px solid #000; }
            th, td { border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <!-- Cabe√ßalho -->
    <header class="container">
        <hgroup>
            <h1>Cota√ß√£o Carvalima</h1>
            <h2>Data base: 6 de janeiro de 2026</h2>
        </hgroup>
        <nav class="no-print">
            <ul>
                <li><strong id="mode-display">Modo: Cliente</strong></li>
            </ul>
            <ul>
                <li><button class="outline secondary" onclick="app.toggleMode()" id="btn-mode">Acessar Admin</button></li>
                <li><button onclick="window.print()">Imprimir / PDF</button></li>
            </ul>
        </nav>
    </header>

    <!-- √Årea Principal -->
    <main class="container">
        
        <!-- Formul√°rio de Adi√ß√£o (Apenas Admin) -->
        <section id="admin-controls" class="no-print" style="display: none;">
            <article>
                <header><strong>Adicionar Novo Item</strong></header>
                <div class="grid">
                    <input type="text" id="inp-product" placeholder="Nome do Produto" style="flex-grow: 2;">
                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <input type="number" id="inp-qty" placeholder="Qtd" value="1">
                        <input type="number" id="inp-cost" placeholder="Custo (R$)" step="0.01" oninput="app.calcNewItem('cost')">
                        <input type="number" id="inp-margin" placeholder="Margem %" step="0.1" oninput="app.calcNewItem('margin')">
                        <input type="number" id="inp-price" placeholder="Venda (R$)" step="0.01" oninput="app.calcNewItem('price')">
                    </div>
                    <button onclick="app.addItem()" style="width: auto;">Adicionar</button>
                </div>
            </article>
        </section>

        <!-- Tabela de Dados -->
        <figure>
            <table>
                <thead>
                    <tr id="table-header">
                        <!-- Renderizado via JS -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Renderizado via JS -->
                </tbody>
            </table>
        </figure>

        <!-- Totais -->
        <div class="summary-card">
            <h3 id="total-display">Total Geral: R$ 0,00</h3>
            <small id="profit-display" style="display: none;" class="text-green no-print"></small>
        </div>

        <!-- Rodap√© do Admin -->
        <footer class="text-center no-print" style="margin-top: 2rem; font-size: 0.8rem; color: #888;">
            <p>Sistema Carvalima SFA v1.2 ‚Ä¢ Persist√™ncia Local</p>
            <button class="outline contrast" onclick="app.clearData()" style="width: auto; padding: 0.2rem 1rem; font-size: 0.7rem;">Limpar Tudo</button>
        </footer>
    </main>

    <script>
        window.app = {
            data: [],
            isAdmin: false,
            STORAGE_KEY: 'carvalima_orcamento_2026',
            PASSWORD_HASH: '090479',

            init() {
                this.load();
                this.render();
            },

            load() {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                try {
                    this.data = stored ? JSON.parse(stored) : [];
                    // Migra√ß√£o de dados antigos (calcular margem se n√£o existir)
                    this.data.forEach(item => {
                        if (item.margin === undefined) {
                            if (item.cost > 0) {
                                item.margin = ((item.price - item.cost) / item.cost) * 100;
                            } else {
                                item.margin = 0;
                            }
                        }
                    });
                } catch (e) {
                    this.data = [];
                }
            },

            save() {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data));
                this.render();
            },

            // L√≥gica de C√°lculo Din√¢mico no Formul√°rio de Adi√ß√£o
            calcNewItem(source) {
                const cost = parseFloat(document.getElementById('inp-cost').value) || 0;
                let margin = parseFloat(document.getElementById('inp-margin').value) || 0;
                let price = parseFloat(document.getElementById('inp-price').value) || 0;

                const costEl = document.getElementById('inp-cost');
                const marginEl = document.getElementById('inp-margin');
                const priceEl = document.getElementById('inp-price');

                if (source === 'cost' || source === 'margin') {
                    // Custo ou Margem mudou -> Calcula Pre√ßo
                    price = cost * (1 + (margin / 100));
                    priceEl.value = price.toFixed(2);
                } else if (source === 'price') {
                    // Pre√ßo mudou -> Calcula Margem (Engenharia Reversa)
                    if (cost > 0) {
                        margin = ((price - cost) / cost) * 100;
                        marginEl.value = margin.toFixed(2);
                    }
                }
            },

            addItem() {
                const name = document.getElementById('inp-product').value;
                const qty = parseFloat(document.getElementById('inp-qty').value) || 1;
                const cost = parseFloat(document.getElementById('inp-cost').value) || 0;
                const margin = parseFloat(document.getElementById('inp-margin').value) || 0;
                const price = parseFloat(document.getElementById('inp-price').value) || 0;

                if (!name) return alert('Digite o nome do produto.');

                this.data.push({ id: Date.now(), name, qty, cost, margin, price });

                // Limpar campos
                document.getElementById('inp-product').value = '';
                document.getElementById('inp-product').focus();
                // Opcional: manter os valores num√©ricos ou limpar? Limpando por seguran√ßa.
                document.getElementById('inp-cost').value = '';
                document.getElementById('inp-margin').value = '';
                document.getElementById('inp-price').value = '';
                
                this.save();
            },

            deleteItem(id) {
                if(confirm('Remover este item?')) {
                    this.data = this.data.filter(item => item.id !== id);
                    this.save();
                }
            },

            // L√≥gica Reativa: Edi√ß√£o na Tabela
            updateItem(id, field, value) {
                const item = this.data.find(i => i.id === id);
                if (!item) return;

                const val = parseFloat(value) || 0;

                if (field === 'qty') {
                    item.qty = val;
                } 
                else if (field === 'name') {
                    item.name = value; // Texto direto, n√£o float
                    this.save();
                    return; 
                }
                else if (field === 'cost') {
                    item.cost = val;
                    // Mudou custo -> Mant√©m margem, atualiza pre√ßo
                    item.price = item.cost * (1 + (item.margin / 100));
                }
                else if (field === 'margin') {
                    item.margin = val;
                    // Mudou margem -> Mant√©m custo, atualiza pre√ßo
                    item.price = item.cost * (1 + (item.margin / 100));
                }
                else if (field === 'price') {
                    item.price = val;
                    // Mudou pre√ßo -> Mant√©m custo, atualiza margem
                    if (item.cost > 0) {
                        item.margin = ((item.price - item.cost) / item.cost) * 100;
                    }
                }

                // Normaliza√ß√£o para evitar dizimas infinitas
                item.price = parseFloat(item.price.toFixed(2));
                item.margin = parseFloat(item.margin.toFixed(2));
                
                this.save();
            },

            toggleMode() {
                if (this.isAdmin) {
                    this.isAdmin = false;
                    this.render();
                } else {
                    setTimeout(() => {
                        let pass = prompt("Digite a senha de administrador:");
                        if (pass && pass.trim() === this.PASSWORD_HASH) {
                            this.isAdmin = true;
                            this.render();
                        } else if (pass !== null) {
                            alert("Senha incorreta.");
                        }
                    }, 50);
                }
            },

            clearData() {
                if (confirm('ATEN√á√ÉO: Isso apagar√° toda a planilha. Continuar?')) {
                    localStorage.removeItem(this.STORAGE_KEY);
                    this.data = [];
                    this.render();
                }
            },

            formatMoney(value) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            },

            render() {
                const tbody = document.getElementById('table-body');
                const thead = document.getElementById('table-header');
                const adminControls = document.getElementById('admin-controls');
                const btnMode = document.getElementById('btn-mode');
                const modeDisplay = document.getElementById('mode-display');
                const profitDisplay = document.getElementById('profit-display');

                if (this.isAdmin) {
                    modeDisplay.innerText = "Modo: ADMIN";
                    modeDisplay.className = "text-red";
                    btnMode.innerText = "Sair do Admin";
                    adminControls.style.display = 'block';
                    profitDisplay.style.display = 'block';
                    
                    thead.innerHTML = `
                        <th>Produto</th>
                        <th class="w-small">Qtd</th>
                        <th class="text-right w-med">Custo</th>
                        <th class="text-right w-small">Mg(%)</th>
                        <th class="text-right w-med">Venda</th>
                        <th class="text-right w-med">Total</th>
                        <th width="40" class="no-print">üóëÔ∏è</th>
                    `;
                } else {
                    modeDisplay.innerText = "Modo: Cliente";
                    modeDisplay.className = "text-green";
                    btnMode.innerText = "Acessar Admin";
                    adminControls.style.display = 'none';
                    profitDisplay.style.display = 'none';

                    thead.innerHTML = `
                        <th>Produto</th>
                        <th width="80" class="text-center">Qtd</th>
                        <th width="150" class="text-right">Valor Total</th>
                    `;
                }

                tbody.innerHTML = '';
                let grandTotal = 0;
                let totalCost = 0;

                this.data.forEach(item => {
                    const totalLine = item.qty * item.price;
                    grandTotal += totalLine;
                    totalCost += (item.qty * item.cost);

                    const tr = document.createElement('tr');
                    
                    if (this.isAdmin) {
                        tr.innerHTML = `
                            <td><input type="text" value="${item.name}" onchange="app.updateItem(${item.id}, 'name', this.value)"></td>
                            <td><input type="number" value="${item.qty}" class="text-center" onchange="app.updateItem(${item.id}, 'qty', this.value)"></td>
                            <td><input type="number" value="${item.cost}" step="0.01" class="text-right" onchange="app.updateItem(${item.id}, 'cost', this.value)"></td>
                            <td><input type="number" value="${item.margin}" step="0.1" class="text-right" onchange="app.updateItem(${item.id}, 'margin', this.value)"></td>
                            <td><input type="number" value="${item.price}" step="0.01" class="text-right" onchange="app.updateItem(${item.id}, 'price', this.value)"></td>
                            <td class="text-right font-bold">${this.formatMoney(totalLine)}</td>
                            <td class="no-print"><button class="outline secondary" onclick="app.deleteItem(${item.id})" style="padding:0.2rem; border:none;">‚úï</button></td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td>${item.name}</td>
                            <td class="text-center">${item.qty}</td>
                            <td class="text-right font-bold">${this.formatMoney(totalLine)}</td>
                        `;
                    }
                    tbody.appendChild(tr);
                });

                document.getElementById('total-display').innerText = `Total Geral: ${this.formatMoney(grandTotal)}`;
                
                if (this.isAdmin) {
                    const profit = grandTotal - totalCost;
                    const marginTotal = grandTotal > 0 ? (profit / grandTotal * 100) : 0;
                    profitDisplay.innerHTML = `Custo Total: ${this.formatMoney(totalCost)} | <strong>Lucro: ${this.formatMoney(profit)} (${marginTotal.toFixed(1)}%)</strong>`;
                }
            }
        };
        app.init();
    </script>
</body>
</html>
