<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="description" content="Personalize sua cesta básica online. Entrega rápida em Cuiabá e Várzea Grande.">
    <meta name="theme-color" content="#ffffff">
    
    <title>Dona Antônia | Cestas Personalizáveis</title>

    <style>
        /* * ⚡ ULTRA-PERFORMANCE CSS 
         * Mobile-First | System Fonts | GPU Accelerated
         */
        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --text: #1e293b;
            --text-light: #64748b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --success: #16a34a;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --font-main: system-ui, -apple-system, sans-serif;
            --nav-height: 64px;
        }

        /* RESET MÍNIMO */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            text-rendering: optimizeLegibility;
            padding-top: var(--nav-height);
            padding-bottom: 100px;
        }

        img { display: block; max-width: 100%; height: auto; object-fit: cover; background-color: #f1f5f9; }
        
        /* LAYOUT UTILS */
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .grid { display: grid; gap: 20px; }
        .flex { display: flex; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .hidden { display: none !important; }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border); z-index: 100;
            display: flex; align-items: center;
            will-change: transform; transition: transform 0.3s;
        }
        body.scroll-down header { transform: translateY(-100%); }

        .logo { font-weight: 800; font-size: 1.25rem; color: var(--text); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .badge { background: #f1f5f9; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }

        /* BUTTONS */
        button {
            cursor: pointer; border: none; font: inherit; font-weight: 600;
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
            padding: 0 20px; height: 44px; border-radius: 50px; /* Altura reduzida para visual mais clean */
            transition: opacity 0.2s, transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        
        button.primary { background: var(--text); color: white; width: 100%; }
        button.secondary { background: #eff6ff; color: var(--primary); width: 100%; font-weight: 700; }
        button.outline { background: white; border: 1px solid var(--border); color: var(--text); width: 100%; }
        button.icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; background: white; border: 1px solid var(--border); }
        button.add-sm { height: 32px; padding: 0 14px; font-size: 0.8rem; border: 1px solid var(--border); background: white; border-radius: 6px; }

        input[type="search"] {
            width: 100%; height: 48px; padding: 0 16px 0 44px;
            border: 1px solid var(--border); border-radius: 50px;
            font-size: 1rem; background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3E%3C/path%3E%3C/svg%3E") no-repeat 14px center/20px;
        }

        /* CARDS (HOME) */
        .card-basket {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius); overflow: hidden;
            display: flex; flex-direction: column;
            transition: transform 0.2s;
        }
        .img-wrapper { 
            aspect-ratio: 1/1; /* Quadrada no mobile */
            width: 100%; position: relative; overflow: hidden; 
        }
        .card-content { padding: 16px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .price-tag { font-size: 1.3rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

        /* LISTA CUSTOMIZER */
        .list-item {
            display: grid; grid-template-columns: 80px 1fr auto; gap: 12px;
            padding: 12px; background: white; border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .list-item:last-child { border-bottom: none; }
        
        .thumb { 
            width: 80px; height: 80px; border-radius: 8px; 
            object-fit: contain; padding: 0; /* Sem borda, maior */
            cursor: zoom-in;
        }
        
        .item-info h3 { 
            font-size: 0.85rem; /* Fonte reduzida mobile */
            font-weight: 600; line-height: 1.3; margin-bottom: 4px; 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
        }
        .item-meta { font-size: 0.8rem; color: var(--text-light); }
        
        .qty-ctrl {
            display: flex; align-items: center; background: white;
            border: 1px solid var(--border); border-radius: 6px; height: 32px;
        }
        .qty-ctrl button { width: 30px; height: 100%; padding: 0; background: none; color: var(--text); font-size: 1.1rem; border-radius: 0; }
        .qty-ctrl span { min-width: 24px; text-align: center; font-weight: 600; font-size: 0.9rem; }

        /* CHECKOUT BAR & CREDIT PILL */
        .float-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.98); border-top: 1px solid var(--border);
            padding: 12px 16px; backdrop-filter: blur(10px); z-index: 90;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .credit-pill {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--text); color: white; padding: 8px 20px; border-radius: 30px;
            font-size: 0.85rem; font-weight: 600; opacity: 0; pointer-events: none;
            transition: all 0.3s; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .credit-pill.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .total-box div { font-size: 1.4rem; font-weight: 800; color: var(--primary); line-height: 1; }
        .btn-checkout { background: var(--success); color: white; flex: 1; max-width: 200px; }

        /* FLOATING ACTIONS (MOBILE) */
        .floating-actions {
            position: fixed; bottom: 100px; right: 16px; z-index: 95;
            display: flex; flex-direction: column; gap: 10px;
        }
        .btn-float {
            width: 44px; height: 44px; border-radius: 50%;
            background: white; border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: var(--text);
            display: flex; align-items: center; justify-content: center;
        }

        /* MODAIS */
        dialog {
            margin: auto; padding: 0; border: none; border-radius: 16px;
            width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            background: white; overflow: hidden;
        }
        dialog::backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
        .modal-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }

        /* GALERIA FULLSCREEN */
        #gallery-modal { max-width: 100%; width: 100%; height: 100%; background: black; border-radius: 0; }
        #gallery-modal .modal-body { height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 0; }
        .gallery-stage { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .gallery-stage img { max-height: 80vh; max-width: 100%; object-fit: contain; background: black; }
        .gallery-thumbs { display: flex; gap: 10px; padding: 20px; overflow-x: auto; justify-content: center; background: rgba(255,255,255,0.1); }
        .g-thumb { width: 60px; height: 60px; border-radius: 4px; border: 2px solid transparent; opacity: 0.6; object-fit: cover; }
        .g-thumb.active { border-color: white; opacity: 1; }

        /* TOAST */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #ef4444; color: white; padding: 10px 24px; border-radius: 50px;
            z-index: 200; font-weight: 600; font-size: 0.9rem; transition: transform 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* SIDEBAR NAV (DESKTOP) */
        .sidebar-nav { display: none; background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; position: sticky; top: 100px; max-height: 80vh; overflow-y: auto; }
        .sn-link { display: block; padding: 6px 0; color: var(--text-light); font-size: 0.9rem; cursor: pointer; }
        .sn-link:hover { color: var(--primary); }
        .sn-title { font-weight: 700; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 10px; color: var(--text); }

        /* DESKTOP */
        @media (min-width: 1024px) {
            .grid-cols-desktop { grid-template-columns: repeat(5, 1fr); gap: 24px; } /* 5 colunas */
            .item-info h3 { font-size: 1rem; }
            .img-wrapper { aspect-ratio: 4/3; } /* Retângulo no desktop */
            
            .customizer-layout { display: grid; grid-template-columns: 1fr 300px; gap: 40px; align-items: start; }
            .float-bar {
                position: sticky; top: 100px; bottom: auto; border: 1px solid var(--border);
                border-radius: var(--radius); flex-direction: column; align-items: stretch;
                padding: 24px; gap: 20px; z-index: 10;
            }
            .credit-pill { top: -60px; width: 100%; text-align: center; }
            .sidebar-nav { display: block; }
            .floating-actions { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container flex justify-between">
            <a href="#" onclick="App.route('home')" class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary)"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Dona Antônia
            </a>
            <span class="badge">Cuiabá & VG</span>
        </div>
    </header>

    <div id="toast" class="toast">Limite atingido!</div>

    <!-- VIEW: HOME -->
    <main id="view-home" class="container" style="padding-top: 20px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 1.8rem; font-weight: 800; color: var(--text); margin-bottom: 8px;">Escolha sua Cesta</h1>
            <p style="color: var(--text-light);">Qualidade e economia para sua família.</p>
        </div>
        
        <div id="basket-grid" class="grid grid-cols-desktop" style="padding-bottom: 60px;">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">Carregando catálogo...</div>
        </div>
    </main>

    <!-- VIEW: CUSTOMIZER -->
    <main id="view-customizer" class="container hidden" style="padding-top: 20px;">
        <div class="flex gap-2" style="margin-bottom: 20px;">
            <button class="icon" onclick="App.route('home')" aria-label="Voltar">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <div>
                <h2 id="customizer-title" style="font-size: 1.2rem; font-weight: 700; line-height: 1.2;">Nome da Cesta</h2>
                <span id="customizer-subtitle" style="font-size: 0.85rem; color: var(--text-light);">Trocas: <span id="changes-count">0</span></span>
            </div>
        </div>

        <div class="customizer-layout">
            <!-- Coluna Esquerda: Listas -->
            <div>
                <div style="position: sticky; top: var(--nav-height); background: var(--bg); padding: 10px 0; z-index: 50;">
                    <input type="search" id="search-input" placeholder="Buscar produto extra..." aria-label="Buscar produto">
                </div>

                <div style="margin-top: 20px;">
                    <h3 style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 12px;">Itens da Cesta</h3>
                    <div id="list-included" style="background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden;"></div>
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 12px;">Adicionar Extras</h3>
                    <div id="list-extras" class="grid" style="gap: 0; background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden;"></div>
                </div>
            </div>

            <!-- Coluna Direita (Desktop Sidebar + Checkout) -->
            <div>
                <!-- Menu Lateral Desktop -->
                <nav class="sidebar-nav" id="desktop-categories"></nav>

                <!-- Box Checkout -->
                <aside class="float-bar">
                    <div id="credit-pill" class="credit-pill"></div>
                    
                    <div class="total-box">
                        <small>Total Final</small>
                        <div id="total-display">R$ 0,00</div>
                    </div>
                    <button class="btn-checkout" onclick="App.checkout()">
                        Finalizar
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </aside>
            </div>
        </div>
    </main>

    <!-- FLOATING ACTIONS (MOBILE) -->
    <div class="floating-actions">
        <button class="btn-float" onclick="App.toggleMobileMenu()">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <button class="btn-float" onclick="window.scrollTo({top:0, behavior:'smooth'})">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
        </button>
    </div>

    <!-- MODAL MENU MOBILE -->
    <dialog id="modal-menu">
        <div class="modal-head">
            <span>Categorias</span>
            <button class="icon" onclick="this.closest('dialog').close()">✕</button>
        </div>
        <div class="modal-body" id="mobile-categories-list"></div>
    </dialog>

    <!-- MODAL GALERIA -->
    <dialog id="gallery-modal">
        <button class="icon" onclick="this.closest('dialog').close()" style="position:absolute; top:20px; right:20px; z-index:10; background:rgba(255,255,255,0.2); border:none; color:white;">✕</button>
        <div class="modal-body">
            <div class="gallery-stage">
                <img id="gallery-main-img" src="" alt="Zoom">
            </div>
            <div class="gallery-thumbs" id="gallery-thumbs"></div>
        </div>
    </dialog>

    <!-- MODAL CHECKOUT -->
    <dialog id="modal-checkout">
        <div class="modal-head">
            <span>Resumo do Pedido</span>
            <button class="icon" onclick="this.closest('dialog').close()">✕</button>
        </div>
        <div class="modal-body">
            <div id="checkout-list" style="margin-bottom: 20px; font-size: 0.9rem;"></div>
            
            <div style="border-top: 1px dashed var(--border); padding-top: 15px; margin-top: 15px;">
                <p style="font-weight: 600; margin-bottom: 10px;">Forma de Pagamento:</p>
                <div class="flex flex-col gap-2">
                    <label class="flex gap-2"><input type="radio" name="payment" value="Pix" checked> Pix</label>
                    <label class="flex gap-2"><input type="radio" name="payment" value="Dinheiro"> Dinheiro</label>
                    <label class="flex gap-2"><input type="radio" name="payment" value="Cartão"> Cartão</label>
                </div>
            </div>

            <button class="primary" onclick="App.sendWhatsapp()" style="margin-top: 24px; background: #25D366; border:none;">
                Enviar no WhatsApp
            </button>
        </div>
    </dialog>

    <script>
        const BASKET_LIMITS = {
            'economica': 5, 'econômica': 5,
            'pequena': 9, 'média': 11, 'media': 11, 'grande': 13,
            'familia': 15, 'família': 15
        };

        const App = {
            data: [],
            cart: {},
            originalCart: {}, // Recupera logica de limite
            currentBasket: null,
            currentLimit: 99,
            basePrice: 0,
            
            async init() {
                try {
                    const res = await fetch('./produtos/produtos.json');
                    if (!res.ok) throw new Error("JSON not found");
                    this.data = await res.json();
                } catch (e) {
                    // Fallback
                    this.data = [
                        {id: "c1", nome: "Cesta Econômica", categoria: "CESTA BÁSICA", valor: 150.00, imagem: "img/cesta1.jpg", items: [{id:"p1", qtd:1}, {id:"p2", qtd:2}]},
                        {id: "p1", nome: "Arroz 5kg", categoria: "ALIMENTOS", valor: 22.90, imagem: "img/arroz.jpg"},
                        {id: "p2", nome: "Feijão 1kg", categoria: "ALIMENTOS", valor: 8.50, imagem: "img/feijao.jpg"},
                        {id: "p3", nome: "Óleo 900ml", categoria: "ALIMENTOS", valor: 6.90, imagem: "img/oleo.jpg"}
                    ];
                }
                
                this.data = this.data.map(p => ({
                    ...p,
                    valor: parseFloat(p.valor || 0),
                    items: p.items || []
                }));

                this.renderHome();
                
                // Scroll Header
                let lastScroll = 0;
                window.addEventListener('scroll', () => {
                    const current = window.scrollY;
                    if (current > 50 && current > lastScroll) document.body.classList.add('scroll-down');
                    else document.body.classList.remove('scroll-down');
                    lastScroll = current;
                }, {passive: true});

                // Search
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.renderExtras(e.target.value.toLowerCase());
                });
            },

            route(viewName) {
                if (viewName === 'home') {
                    document.getElementById('view-customizer').classList.add('hidden');
                    document.getElementById('view-home').classList.remove('hidden');
                    window.scrollTo(0,0);
                } else {
                    document.getElementById('view-home').classList.add('hidden');
                    document.getElementById('view-customizer').classList.remove('hidden');
                    window.scrollTo(0,0);
                }
            },

            renderHome() {
                const cestas = this.data.filter(p => p.categoria.includes('CESTA'));
                const grid = document.getElementById('basket-grid');
                
                grid.innerHTML = cestas.map((c, index) => `
                    <article class="card-basket">
                        <div class="img-wrapper">
                            <img src="${c.imagem}" alt="${c.nome}" loading="${index===0?'eager':'lazy'}"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1 1\' fill=\'%23e2e8f0\'%3E%3C/svg%3E'">
                        </div>
                        <div class="card-content">
                            <h3 style="font-size:1.1rem; font-weight:700;">${c.nome}</h3>
                            <div class="price-tag">R$ ${c.valor.toFixed(2).replace('.', ',')}</div>
                            <div class="flex gap-2">
                                <button class="primary" onclick="App.openCustomizer('${c.id}')">Personalizar</button>
                                <button class="secondary" onclick="App.quickCheckout('${c.id}')">Encomendar</button>
                            </div>
                        </div>
                    </article>
                `).join('');
            },

            openCustomizer(id) {
                const cesta = this.data.find(c => c.id == id);
                if (!cesta) return;

                this.currentBasket = cesta;
                this.cart = {};
                this.originalCart = {}; // Reset
                
                // Set Limit
                const nameKey = cesta.nome.toLowerCase().replace('cesta ', '').trim();
                this.currentLimit = BASKET_LIMITS[nameKey] || 99;

                let itemsValue = 0;
                cesta.items.forEach(item => {
                    let prod = this.data.find(p => p.id == item.id);
                    if (!prod) prod = this.data.find(p => p.nome === item.nome && !p.categoria.includes('CESTA'));
                    
                    if (prod) {
                        const qtd = item.qtd || 1;
                        this.cart[prod.id] = (this.cart[prod.id] || 0) + qtd;
                        itemsValue += prod.valor * qtd;
                    }
                });
                
                this.originalCart = {...this.cart}; // Clone
                this.basePrice = Math.max(0, cesta.valor - itemsValue);

                document.getElementById('customizer-title').innerText = cesta.nome;
                document.getElementById('search-input').value = '';
                
                this.renderIncluded();
                this.renderExtras();
                this.updateTotal();
                this.route('customizer');
            },

            renderIncluded() {
                const container = document.getElementById('list-included');
                const ids = Object.keys(this.cart);
                
                if (ids.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-light)">Nenhum item.</div>';
                    return;
                }
                container.innerHTML = ids.map(id => {
                    const p = this.data.find(x => x.id == id);
                    if (!p) return '';
                    return this.createRowHTML(p, this.cart[id], true);
                }).join('');
            },

            renderExtras(term = '') {
                const container = document.getElementById('list-extras');
                const navDesktop = document.getElementById('desktop-categories');
                const navMobile = document.getElementById('mobile-categories-list');

                const extras = this.data.filter(p => 
                    !p.categoria.includes('CESTA') && 
                    (!term || p.nome.toLowerCase().includes(term))
                ).slice(0, 60);

                if (extras.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center;">Nenhum produto.</div>';
                    return;
                }

                const grouped = {};
                extras.forEach(p => {
                    const cat = p.categoria || 'OUTROS';
                    if(!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(p);
                });

                // Render Sidebar Nav & Content
                let html = '';
                let navHtml = '<div class="sn-title">Categorias</div>';
                
                for (const [cat, products] of Object.entries(grouped)) {
                    const anchor = `cat-${cat.replace(/\s/g, '-')}`;
                    navHtml += `<a class="sn-link" onclick="document.getElementById('${anchor}').scrollIntoView({behavior:'smooth'})">${cat}</a>`;
                    
                    html += `<div id="${anchor}" style="background:#f8fafc; padding:10px 16px; font-weight:700; font-size:0.8rem; color:var(--text-light); border-bottom:1px solid var(--border); margin-top:20px;">${cat}</div>`;
                    html += products.map(p => this.createRowHTML(p, this.cart[p.id] || 0, false)).join('');
                }
                
                container.innerHTML = html;
                if (!term) {
                    navDesktop.innerHTML = navHtml;
                    navMobile.innerHTML = navHtml.replace(/sn-link/g, 'sn-link style="padding:12px; border-bottom:1px solid #eee;"').replace(/sn-title/g, 'hidden');
                }
            },

            createRowHTML(p, qtd, isIncludedSection) {
                if (isIncludedSection && qtd === 0) return '';
                // Galeria Click
                const clickAction = `App.openGallery('${p.id}')`;
                
                return `
                <div class="list-item">
                    <img src="${p.imagem}" class="thumb" loading="lazy" onclick="${clickAction}"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1 1\' fill=\'%23f1f5f9\'%3E%3C/svg%3E'">
                    
                    <div class="item-info">
                        <h3>${p.nome}</h3>
                        <div class="item-meta">R$ ${p.valor.toFixed(2).replace('.', ',')}</div>
                    </div>

                    ${qtd === 0 && !isIncludedSection 
                        ? `<button class="add-sm" onclick="App.changeQty('${p.id}', 1)">Adicionar</button>`
                        : `<div class="qty-ctrl">
                               <button onclick="App.changeQty('${p.id}', -1)">-</button>
                               <span>${qtd}</span>
                               <button onclick="App.changeQty('${p.id}', 1)">+</button>
                           </div>`
                    }
                </div>`;
            },

            changeQty(id, delta) {
                // Check Removal Limit
                if (delta < 0 && this.originalCart[id]) {
                    const currentRemovals = this.calculateRemovals();
                    // Se a quantidade atual é > 0 e vai virar 0 ou diminuir além do permitido?
                    // Simplificação: Contamos quantos itens originais foram zerados.
                    const simulatedCart = {...this.cart};
                    simulatedCart[id] = (simulatedCart[id] || 0) + delta;
                    if (simulatedCart[id] <= 0) {
                        // Vai zerar este item. Verifica se excede o limite.
                        let removals = 0;
                        for(let k in this.originalCart) {
                            if (this.originalCart[k] > 0 && (!simulatedCart[k] || simulatedCart[k] <= 0)) removals++;
                        }
                        if (removals > this.currentLimit) {
                            this.showToast(`Limite de ${this.currentLimit} trocas!`);
                            return;
                        }
                    }
                }

                if (!this.cart[id]) this.cart[id] = 0;
                this.cart[id] += delta;
                if (this.cart[id] <= 0) delete this.cart[id];

                this.renderIncluded();
                this.updateTotal();
            },

            calculateRemovals() {
                let removals = 0;
                for (let k in this.originalCart) {
                    if (this.originalCart[k] > 0 && (!this.cart[k] || this.cart[k] <= 0)) removals++;
                }
                return removals;
            },

            updateTotal() {
                let totalItems = 0;
                for (const [id, qtd] of Object.entries(this.cart)) {
                    const p = this.data.find(x => x.id == id);
                    if (p) totalItems += p.valor * qtd;
                }
                
                const calcTotal = totalItems + this.basePrice;
                const finalTotal = Math.max(calcTotal, this.currentBasket.valor);
                
                // Credit Logic
                const pill = document.getElementById('credit-pill');
                if (calcTotal < this.currentBasket.valor) {
                    const credit = this.currentBasket.valor - calcTotal;
                    if (credit > 0) {
                        pill.innerHTML = `Você tem <b>R$ ${credit.toFixed(2).replace('.', ',')}</b> de crédito!`;
                        pill.classList.add('show');
                    } else {
                        pill.classList.remove('show');
                    }
                } else {
                    pill.classList.remove('show');
                }

                // Limits Badge
                const removals = this.calculateRemovals();
                document.getElementById('changes-count').innerText = `${removals}/${this.currentLimit}`;

                document.getElementById('total-display').innerText = `R$ ${finalTotal.toFixed(2).replace('.', ',')}`;
            },

            quickCheckout(basketId) {
                // Simula abertura do customizer e vai direto pro checkout
                const cesta = this.data.find(c => c.id == basketId);
                if (!cesta) return;
                
                this.currentBasket = cesta;
                this.cart = {};
                this.basePrice = 0; // Preço cheio no quick checkout
                
                // Reconstrói carrinho como se fosse "customizado" mas sem trocas
                let itemsValue = 0;
                cesta.items.forEach(item => {
                    let prod = this.data.find(p => p.id == item.id) || this.data.find(p => p.nome === item.nome);
                    if (prod) {
                        this.cart[prod.id] = (item.qtd || 1);
                        itemsValue += prod.valor * (item.qtd || 1);
                    }
                });
                this.basePrice = Math.max(0, cesta.valor - itemsValue);
                
                this.checkout();
            },

            checkout() {
                if (Object.keys(this.cart).length === 0) {
                    this.showToast("Cesta vazia!");
                    return;
                }
                
                const listEl = document.getElementById('checkout-list');
                let html = '<ul style="list-style:none;">';
                let total = 0;

                for (const [id, qtd] of Object.entries(this.cart)) {
                    const p = this.data.find(x => x.id == id);
                    if (p) {
                        const sub = p.valor * qtd;
                        total += sub;
                        // Ajuste: Não mostra valor unitário, apenas total da linha
                        html += `<li class="flex justify-between" style="margin-bottom:8px; border-bottom:1px solid #f1f5f9; padding-bottom:8px;">
                            <span>${qtd}x ${p.nome}</span>
                            <b>R$ ${sub.toFixed(2).replace('.', ',')}</b>
                        </li>`;
                    }
                }
                
                const finalTotal = Math.max(total + this.basePrice, this.currentBasket.valor);
                
                html += `</ul>
                <div class="flex justify-between" style="margin-top:15px; font-size:1.1rem; color:var(--primary); font-weight:800;">
                    <span>TOTAL</span>
                    <span>R$ ${finalTotal.toFixed(2).replace('.', ',')}</span>
                </div>`;

                listEl.innerHTML = html;
                document.getElementById('modal-checkout').showModal();
            },

            // GALLERY LOGIC RECOVERED
            openGallery(prodId) {
                const p = this.data.find(x => x.id == prodId);
                if(!p) return;

                const modal = document.getElementById('gallery-modal');
                const mainImg = document.getElementById('gallery-main-img');
                const thumbsContainer = document.getElementById('gallery-thumbs');

                mainImg.src = p.imagem;
                
                // Tenta gerar URLs para p001A.webp, p001B.webp...
                const baseName = p.imagem.replace(/(\.[^.]+)$/, ''); // remove extensao
                const ext = p.imagem.match(/(\.[^.]+)$/)[0]; // pega extensao
                
                // Array de imagens potenciais (Principal + A + B)
                const attempts = [p.imagem, `${baseName}A${ext}`, `${baseName}B${ext}`];
                
                thumbsContainer.innerHTML = '';
                attempts.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        const thumb = document.createElement('img');
                        thumb.src = src;
                        thumb.className = 'g-thumb';
                        thumb.onclick = () => {
                            mainImg.src = src;
                            document.querySelectorAll('.g-thumb').forEach(t => t.classList.remove('active'));
                            thumb.classList.add('active');
                        };
                        thumbsContainer.appendChild(thumb);
                    };
                });
                
                modal.showModal();
            },

            toggleMobileMenu() {
                document.getElementById('modal-menu').showModal();
            },

            sendWhatsapp() {
                const payment = document.querySelector('input[name="payment"]:checked').value;
                let msg = `*PEDIDO: ${this.currentBasket.nome}*\n------------------\n`;
                let total = 0;
                for (const [id, qtd] of Object.entries(this.cart)) {
                    const p = this.data.find(x => x.id == id);
                    if (p) {
                        total += p.valor * qtd;
                        msg += `${qtd}x ${p.nome}\n`;
                    }
                }
                const finalTotal = Math.max(total + this.basePrice, this.currentBasket.valor);
                msg += `------------------\n*TOTAL: R$ ${finalTotal.toFixed(2).replace('.', ',')}*\n`;
                msg += `Pagamento: ${payment}`;
                window.open(`https://api.whatsapp.com/send?phone=5565998150975&text=${encodeURIComponent(msg)}`, '_blank');
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
