<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V1 - CRM & P√≥s-Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilo Consistente (Desktop Compacto) */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1400px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        .compact-input { padding: 0.3rem; font-size: 0.9rem; }
        
        /* Utilit√°rios de Scroll */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .btn-zap { transition: all 0.2s; }
        .btn-zap:hover { transform: scale(1.05); }
    </style>
</head>
<body class="text-gray-800">

    <div class="app-container p-4">
        
        <!-- Cabe√ßalho -->
        <header class="bg-white shadow-sm rounded-lg p-3 mb-3 flex justify-between items-center border border-gray-200">
            <div class="flex items-center gap-4">
                <div class="bg-purple-600 text-white p-2 rounded">
                    <i class="fa-solid fa-handshake"></i>
                </div>
                <h1 class="font-bold text-lg text-gray-700">M√≥dulo 3: CRM & Intelig√™ncia</h1>
            </div>
            
            <nav class="flex gap-2">
                <button onclick="window.location.href='cadastro.html'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded text-sm font-medium transition">
                    1. Cadastro
                </button>
                <button onclick="window.location.href='vendas.html'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded text-sm font-medium transition">
                    2. Vendas
                </button>
                <button class="bg-purple-600 text-white px-4 py-1 rounded text-sm font-medium shadow-sm">
                    3. CRM
                </button>
            </nav>

            <div class="flex gap-2">
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importarDadosExternos(this)" multiple>
                <button onclick="document.getElementById('importInput').click()" class="border border-gray-300 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-50" title="Importar JSON de Vendas ou Clientes">
                    <i class="fa-solid fa-upload mr-1"></i> Importar Dados
                </button>
                <button onclick="atualizarDados()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 shadow-sm">
                    <i class="fa-solid fa-sync mr-1"></i> Atualizar
                </button>
            </div>
        </header>

        <!-- KPI Cards (Resumo) -->
        <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="bg-white p-3 rounded-lg border-l-4 border-blue-500 shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Total Clientes</p>
                    <h3 class="text-xl font-bold text-gray-800" id="kpiClientes">0</h3>
                </div>
                <i class="fa-solid fa-users text-blue-200 text-3xl"></i>
            </div>
            <div class="bg-white p-3 rounded-lg border-l-4 border-green-500 shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Vendas Realizadas</p>
                    <h3 class="text-xl font-bold text-gray-800" id="kpiVendas">0</h3>
                </div>
                <i class="fa-solid fa-check-circle text-green-200 text-3xl"></i>
            </div>
            <div class="bg-white p-3 rounded-lg border-l-4 border-purple-500 shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Ticket M√©dio</p>
                    <h3 class="text-xl font-bold text-gray-800">R$ <span id="kpiTicket">0,00</span></h3>
                </div>
                <i class="fa-solid fa-chart-line text-purple-200 text-3xl"></i>
            </div>
            <div class="bg-white p-3 rounded-lg border-l-4 border-orange-500 shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Clientes Inativos</p>
                    <h3 class="text-xl font-bold text-gray-800" id="kpiInativos">0</h3>
                </div>
                <i class="fa-solid fa-user-clock text-orange-200 text-3xl"></i>
            </div>
        </div>

        <!-- √Årea Principal Dividida -->
        <div class="flex flex-1 gap-4 overflow-hidden">
            
            <!-- ESQUERDA: Radar de Resgate (Ciclo de Compra) -->
            <div class="w-1/2 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
                <div class="p-3 border-b border-gray-100 bg-orange-50 rounded-t-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-bold text-orange-800 text-sm uppercase"><i class="fa-solid fa-radar mr-2"></i>Radar de Resgate</h2>
                        <span class="text-[10px] bg-orange-200 text-orange-800 px-2 py-0.5 rounded-full font-bold">Recupera√ß√£o</span>
                    </div>
                    
                    <!-- Filtro de Ciclo -->
                    <div class="flex items-center gap-2 bg-white p-2 rounded border border-orange-200">
                        <label class="text-xs font-bold text-gray-600">Mostrar quem n√£o compra h√°:</label>
                        <input type="number" id="diasInativo" value="30" class="w-16 border border-gray-300 rounded text-center text-sm p-1 font-bold text-orange-600" onchange="renderizarRadar()">
                        <span class="text-xs font-bold text-gray-600">dias</span>
                    </div>
                </div>

                <div class="flex-1 overflow-auto p-0 bg-gray-50">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-500 text-xs sticky top-0 shadow-sm">
                            <tr>
                                <th class="p-2">Cliente</th>
                                <th class="p-2">√öltima Compra</th>
                                <th class="p-2 text-center">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="listaRadar" class="text-sm divide-y divide-gray-200 bg-white">
                            <!-- Inserido via JS -->
                        </tbody>
                    </table>
                    <div id="emptyRadar" class="hidden text-center text-gray-400 p-8">
                        <i class="fa-solid fa-check-double text-3xl mb-2"></i>
                        <p class="text-xs">Todos os clientes compraram recentemente!</p>
                    </div>
                </div>
            </div>

            <!-- DIREITA: P√≥s-Venda (√öltimas Vendas) -->
            <div class="w-1/2 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
                <div class="p-3 border-b border-gray-100 bg-blue-50 rounded-t-lg flex justify-between items-center">
                    <h2 class="font-bold text-blue-800 text-sm uppercase"><i class="fa-solid fa-comments mr-2"></i>P√≥s-Venda Recente</h2>
                    <span class="text-[10px] bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full font-bold">Relacionamento</span>
                </div>

                <div class="flex-1 overflow-auto p-2 bg-gray-50 custom-scroll">
                    <div id="listaPosVenda" class="space-y-3">
                        <!-- Cards de P√≥s Venda -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script L√≥gico -->
    <script>
        // --- 1. CONFIGURA√á√ÉO E DADOS ---
        const KEY_CLIENTES = 'sistema_empresarial_clientes';
        const KEY_PEDIDOS = 'sistema_empresarial_vendas';
        
        let clientes = [];
        let vendas = [];

        // Templates de Mensagem (Whatsapp)
        const TEMPLATES = {
            agradecimento: "Ol√° {nome}! Tudo bem? Passando para agradecer pela prefer√™ncia na sua compra do dia {data}. Espero que tenha gostado dos produtos! Qualquer coisa estou √† disposi√ß√£o. üõí",
            insta: "Oie {nome}! üòÉ Gostaria de te convidar para seguir nosso Instagram. Postamos promo√ß√µes rel√¢mpago por l√°! Segue o link: [SEU_INSTA_AQUI]",
            avaliacao: "Ol√° {nome}, tudo joia? Poderia nos dar uma forcinha? üôè Avalie nossa empresa no Google, ajuda muito! Segue o link: [SEU_LINK_GOOGLE_AQUI]",
            resgate: "Ol√° {nome}! Sumiu hein? üòâ Faz {dias} dias que n√£o te vemos. Temos cestas fresquinhas chegando. Que tal aproveitar um desconto especial de retorno? Me chama aqui!",
            feedback: "Oi {nome}, queria saber se deu tudo certo com a entrega da cesta no dia {data}? O arroz estava ok?"
        };

        window.onload = () => {
            atualizarDados();
        };

        // --- 2. IMPORTA√á√ÉO E PROCESSAMENTO DE DADOS ---
        
        function atualizarDados() {
            // Tenta carregar do LocalStorage
            const cLocal = localStorage.getItem(KEY_CLIENTES);
            const vLocal = localStorage.getItem(KEY_PEDIDOS);

            if (cLocal) clientes = JSON.parse(cLocal);
            if (vLocal) vendas = JSON.parse(vLocal);

            calcularKPIs();
            renderizarRadar();
            renderizarPosVenda();
        }

        function importarDadosExternos(input) {
            // Permite carregar arquivos backup caso o localStorage esteja vazio
            const files = input.files;
            if (files.length === 0) return;

            let carregados = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        
                        // Detec√ß√£o simples da estrutura para saber se √© Cliente ou Venda
                        if (json.length > 0) {
                            if (json[0].hasOwnProperty('financeiro')) {
                                vendas = json;
                                localStorage.setItem(KEY_PEDIDOS, JSON.stringify(vendas));
                            } else if (json[0].hasOwnProperty('nome')) {
                                clientes = json;
                                localStorage.setItem(KEY_CLIENTES, JSON.stringify(clientes));
                            }
                        }
                        carregados++;
                        if(carregados === files.length) {
                            atualizarDados();
                            alert('Dados importados e processados!');
                        }
                    } catch (error) {
                        console.error("Erro no arquivo", error);
                    }
                };
                reader.readAsText(file);
            });
        }

        function calcularKPIs() {
            document.getElementById('kpiClientes').innerText = clientes.length;
            document.getElementById('kpiVendas').innerText = vendas.length;
            
            if (vendas.length > 0) {
                const totalFaturamento = vendas.reduce((acc, v) => acc + v.financeiro.total, 0);
                const ticket = totalFaturamento / vendas.length;
                document.getElementById('kpiTicket').innerText = ticket.toFixed(2).replace('.', ',');
            }
        }

        // --- 3. L√ìGICA DO RADAR (Ciclo de Compra) ---

        function renderizarRadar() {
            const diasCorte = parseInt(document.getElementById('diasInativo').value) || 30;
            const tbody = document.getElementById('listaRadar');
            const empty = document.getElementById('emptyRadar');
            tbody.innerHTML = '';
            
            // 1. Mapa da √∫ltima compra por cliente
            const mapaUltimaCompra = {};
            vendas.forEach(v => {
                const dataVenda = new Date(v.data);
                if (!mapaUltimaCompra[v.cliente.id] || dataVenda > mapaUltimaCompra[v.cliente.id]) {
                    mapaUltimaCompra[v.cliente.id] = dataVenda;
                }
            });

            // 2. Filtrar clientes inativos
            const hoje = new Date();
            let inativosCount = 0;

            const listaInativos = clientes.filter(c => {
                const ultimaData = mapaUltimaCompra[c.id];
                
                // Se nunca comprou, consideramos a data de cadastro ou uma data antiga
                if (!ultimaData) return false; // Opcional: mostrar quem nunca comprou? Por enquanto foca em reten√ß√£o.

                const diffTime = Math.abs(hoje - ultimaData);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                c.diasSemComprar = diffDays;
                c.ultimaData = ultimaData;
                return diffDays >= diasCorte;
            });

            // Ordenar: quem est√° a mais tempo sem comprar primeiro
            listaInativos.sort((a, b) => b.diasSemComprar - a.diasSemComprar);

            document.getElementById('kpiInativos').innerText = listaInativos.length;

            if (listaInativos.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                listaInativos.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-orange-50 transition border-b border-gray-100";
                    
                    const dataFormatada = c.ultimaData.toLocaleDateString('pt-BR');
                    
                    tr.innerHTML = `
                        <td class="p-2">
                            <div class="font-bold text-gray-800">${c.nome}</div>
                            <div class="text-[10px] text-gray-500">${c.telefone}</div>
                        </td>
                        <td class="p-2">
                            <span class="bg-red-100 text-red-700 text-xs font-bold px-1.5 py-0.5 rounded">${c.diasSemComprar} dias</span>
                            <div class="text-[10px] text-gray-400 mt-1">Desde ${dataFormatada}</div>
                        </td>
                        <td class="p-2 text-center">
                            <button onclick="enviarZap('${c.telefone}', 'resgate', '${c.nome}', null, '${c.diasSemComprar}')" 
                                class="btn-zap bg-green-500 text-white w-8 h-8 rounded-full shadow hover:bg-green-600 flex items-center justify-center mx-auto" title="Enviar Oferta de Retorno">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- 4. L√ìGICA DO P√ìS-VENDA (Lista Cronol√≥gica) ---

        function renderizarPosVenda() {
            const container = document.getElementById('listaPosVenda');
            container.innerHTML = '';

            // Copia e inverte para pegar mais recentes
            const ultimasVendas = [...vendas].sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 50);

            ultimasVendas.forEach(v => {
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded border border-blue-100 shadow-sm hover:shadow-md transition";
                
                const dataObj = new Date(v.data);
                const dataStr = dataObj.toLocaleDateString('pt-BR');
                const diffDays = Math.floor((new Date() - dataObj) / (1000 * 60 * 60 * 24));
                
                let badgeTempo = diffDays === 0 ? "Hoje" : (diffDays === 1 ? "Ontem" : `${diffDays} dias atr√°s`);
                let corBadge = diffDays <= 2 ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600";

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-[10px] font-bold ${corBadge} px-2 rounded-full">${badgeTempo}</span>
                            <h3 class="font-bold text-gray-800 text-sm mt-1">${v.cliente.nome}</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Pedido #${v.id.toString().slice(-4)}</div>
                            <div class="text-xs font-bold text-blue-600">R$ ${v.financeiro.total.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-2 rounded mb-3">
                        <p class="text-[11px] text-gray-600 truncate"><i class="fa-solid fa-basket-shopping mr-1"></i>${v.itens.map(i => i.tipo).join(', ')}</p>
                    </div>

                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="enviarZap('${v.cliente.telefone}', 'agradecimento', '${v.cliente.nome}', '${dataStr}')" 
                            class="btn-zap flex flex-col items-center justify-center p-1 bg-white border border-gray-200 rounded hover:bg-green-50 hover:border-green-300">
                            <i class="fa-brands fa-whatsapp text-green-500 mb-1"></i>
                            <span class="text-[9px] text-gray-600 font-bold">Obrigado</span>
                        </button>
                        
                        <button onclick="enviarZap('${v.cliente.telefone}', 'feedback', '${v.cliente.nome}', '${dataStr}')" 
                            class="btn-zap flex flex-col items-center justify-center p-1 bg-white border border-gray-200 rounded hover:bg-blue-50 hover:border-blue-300">
                            <i class="fa-regular fa-comment-dots text-blue-500 mb-1"></i>
                            <span class="text-[9px] text-gray-600 font-bold">Feedback</span>
                        </button>

                        <button onclick="enviarZap('${v.cliente.telefone}', 'avaliacao', '${v.cliente.nome}')" 
                            class="btn-zap flex flex-col items-center justify-center p-1 bg-white border border-gray-200 rounded hover:bg-yellow-50 hover:border-yellow-300">
                            <i class="fa-solid fa-star text-yellow-500 mb-1"></i>
                            <span class="text-[9px] text-gray-600 font-bold">Avaliar</span>
                        </button>

                        <button onclick="enviarZap('${v.cliente.telefone}', 'insta', '${v.cliente.nome}')" 
                            class="btn-zap flex flex-col items-center justify-center p-1 bg-white border border-gray-200 rounded hover:bg-pink-50 hover:border-pink-300">
                            <i class="fa-brands fa-instagram text-pink-500 mb-1"></i>
                            <span class="text-[9px] text-gray-600 font-bold">Seguir</span>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 5. FUN√á√ÉO DE ENVIO (ZAP) ---

        function enviarZap(telefone, tipo, nome, dataVenda = '', dias = '') {
            if (!telefone) return alert("Cliente sem telefone cadastrado.");

            // Limpa o telefone para formato internacional (55 + DDD + Numero)
            let phone = telefone.replace(/\D/g, '');
            if (phone.length < 10) return alert("N√∫mero de telefone inv√°lido");
            if (!phone.startsWith('55')) phone = '55' + phone;

            // Prepara a mensagem
            let msg = TEMPLATES[tipo];
            
            // Substitui vari√°veis
            const primeiroNome = nome.split(' ')[0];
            msg = msg.replace('{nome}', primeiroNome);
            if (dataVenda) msg = msg.replace('{data}', dataVenda);
            if (dias) msg = msg.replace('{dias}', dias);

            // Encode para URL
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            
            // Abre em nova aba
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
