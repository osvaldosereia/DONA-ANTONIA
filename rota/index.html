<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMAS - Rota de Entrega</title>
    <!-- CSS Minimalista para Mobile -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #16a34a;
            --card-bg: #ffffff;
        }
        
        body { background-color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; }
        .container { max-width: 500px; padding-top: 10px; }
        
        /* Dashboard de Status */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card small { display: block; color: var(--secondary); font-size: 0.7rem; text-transform: uppercase; }
        .stat-card strong { font-size: 1.2rem; }

        /* Cards de Entrega */
        #listaEntregas { display: flex; flex-direction: column; gap: 12px; }
        .delivery-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-left: 6px solid var(--primary);
            transition: all 0.2s;
        }
        .delivery-card.completed { border-left-color: var(--success); opacity: 0.6; transform: scale(0.98); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 20px; background: #e2e8f0; color: #475569; font-weight: bold; }
        .client-name { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0; }
        .address { font-size: 0.85rem; color: #475569; margin: 4px 0; line-height: 1.4; }
        .product-info { font-size: 0.8rem; background: #f8fafc; padding: 8px; border-radius: 8px; margin-top: 10px; border: 1px solid #edf2f7; }

        /* A√ß√µes */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-action { margin-bottom: 0; font-size: 0.8rem; padding: 8px; border-radius: 8px; }
        .btn-gps { background-color: #ef4444; border: none; }
        .btn-check { background-color: var(--success); border: none; }
        .btn-undo { background-color: var(--secondary); border: none; }

        /* Estilo do Upload */
        .upload-screen { text-align: center; padding: 40px 20px; }
        .upload-icon { font-size: 4rem; margin-bottom: 20px; display: block; }
        
        .hidden { display: none !important; }
        .sticky-search { position: sticky; top: 0; background: #f1f5f9; padding: 10px 0; z-index: 100; }
    </style>
</head>
<body>

    <main class="container">
        <!-- Ecr√£ de Boas-vindas / Upload -->
        <section id="uploadSection" class="upload-screen">
            <span class="upload-icon">üöö</span>
            <h2>Log√≠stica Express</h2>
            <p>Carregue o relat√≥rio de vendas para gerar a sua rota de hoje.</p>
            <input type="file" id="jsonInput" accept=".json" hidden>
            <button onclick="document.getElementById('jsonInput').click()">Selecionar Ficheiro JSON</button>
        </section>

        <!-- Painel Principal (Dashboard) -->
        <section id="mainSection" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <small>Total</small>
                    <strong id="totalCount">0</strong>
                </div>
                <div class="stat-card">
                    <small>Pendente</small>
                    <strong id="pendingCount" style="color: var(--primary)">0</strong>
                </div>
                <div class="stat-card">
                    <small>Feito</small>
                    <strong id="doneCount" style="color: var(--success)">0</strong>
                </div>
            </div>

            <div class="sticky-search">
                <div style="display: flex; gap: 8px;">
                    <input type="search" id="searchInput" placeholder="Filtrar por Rota ou Bairro..." oninput="render()">
                    <button class="outline" style="width: auto; padding: 0 15px;" onclick="resetApp()" title="Reset">‚ôªÔ∏è</button>
                </div>
            </div>

            <div id="listaEntregas">
                <!-- Cards injetados via JS -->
            </div>
        </section>
    </main>

    <script>
        /**
         * SISTEMAS - Motor de Gest√£o de Rotas
         * Persist√™ncia em LocalStorage
         */
        const STORAGE_KEY = 'sistemas_rota_v1';
        let state = {
            entregas: []
        };

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                state.entregas = JSON.parse(saved);
                initApp();
            }
        });

        // Handler de Ficheiro
        document.getElementById('jsonInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const rawData = JSON.parse(event.target.result);
                    // Normaliza√ß√£o e Inje√ß√£o de Estado Inicial
                    state.entregas = rawData.map(item => ({
                        id: item.id,
                        nome: item.detalhes_cliente.nome,
                        tel: item.detalhes_cliente.tel,
                        morada: `${item.detalhes_cliente.endereco}, ${item.detalhes_cliente.bairro}`,
                        cidade: item.detalhes_cliente.cidade,
                        bairro: item.detalhes_cliente.bairro,
                        rota: item.rota,
                        produto: item.detalhes_produto.nome,
                        qtd: item.qty,
                        total: item.total,
                        pagamento: item.pag,
                        concluido: false
                    }));
                    saveState();
                    initApp();
                } catch (err) {
                    alert("Erro ao processar o JSON. Verifique o formato.");
                }
            };
            reader.readAsText(e.target.files[0]);
        });

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.entregas));
        }

        function initApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            render();
        }

        function resetApp() {
            if(confirm("Deseja apagar a rota atual e carregar um novo ficheiro?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function toggleStatus(id) {
            state.entregas = state.entregas.map(item => 
                item.id === id ? { ...item, concluido: !item.concluido } : item
            );
            saveState();
            render();
        }

        function render() {
            const container = document.getElementById('listaEntregas');
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            // Filtro e Ordena√ß√£o (Pendentes primeiro)
            const filtered = state.entregas
                .filter(i => i.rota.toLowerCase().includes(term) || i.bairro.toLowerCase().includes(term) || i.nome.toLowerCase().includes(term))
                .sort((a, b) => a.concluido - b.concluido);

            // Atualiza Stats
            document.getElementById('totalCount').innerText = filtered.length;
            document.getElementById('pendingCount').innerText = filtered.filter(i => !i.concluido).length;
            document.getElementById('doneCount').innerText = filtered.filter(i => i.concluido).length;

            container.innerHTML = '';

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = `delivery-card ${item.concluido ? 'completed' : ''}`;
                
                // URL do Google Maps
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.morada + ', ' + item.cidade)}`;
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="badge">ROTA: ${item.rota}</span>
                        <span class="badge" style="background:#fef3c7; color:#92400e">${item.pagamento}</span>
                    </div>
                    <h3 class="client-name">${item.nome}</h3>
                    <p class="address">
                        üìç ${item.morada}<br>
                        üèôÔ∏è ${item.cidade}
                    </p>
                    <div class="product-info">
                        <strong>${item.produto}</strong> (x${item.qtd})<br>
                        <span style="color: var(--primary); font-weight: bold;">VALOR: R$ ${item.total.toFixed(2)}</span>
                    </div>
                    <div class="actions">
                        <a href="${mapsUrl}" target="_blank" class="btn-action btn-gps" role="button">Abrir GPS</a>
                        <button class="btn-action ${item.concluido ? 'btn-undo' : 'btn-check'}" onclick="toggleStatus('${item.id}')">
                            ${item.concluido ? 'Reabrir' : 'Concluir'}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>
