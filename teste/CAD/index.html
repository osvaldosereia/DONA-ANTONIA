<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CADASTRO CLIENTES DONA ANTONIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons via Unpkg - Versão mais estável -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal-active { overflow: hidden; }
        [onclick] { cursor: pointer; }
        /* Garantia que os SVGs tenham tamanho caso o Lucide demore a injetar */
        i svg { width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app" class="p-4 md:p-8">
        <!-- HEADER -->
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-slate-900">CADASTRO CLIENTES DONA ANTONIA</h1>
                <p class="text-slate-500 font-medium">Sistema de Gestão Local-First</p>
            </div>
            
            <div class="flex flex-wrap gap-3 w-full md:w-auto">
                <input type="file" id="importInput" class="hidden" accept=".json" onchange="importFromJson(event)">
                <button onclick="document.getElementById('importInput').click()" class="flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm font-medium">
                    <i data-lucide="upload" class="w-4 h-4 mr-1"></i>
                    Importar Banco
                </button>
                <button onclick="exportToJson()" class="flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm font-medium">
                    <i data-lucide="download" class="w-4 h-4 mr-1"></i>
                    Exportar JSON
                </button>
                <button onclick="openModal()" class="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md text-sm font-medium">
                    <i data-lucide="user-plus" class="w-4 h-4 mr-1"></i>
                    Novo Cliente
                </button>
            </div>
        </div>

        <!-- SEARCH -->
        <div class="max-w-7xl mx-auto mb-6">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Buscar por nome, cidade ou observação..." 
                    class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm"
                    oninput="renderTable()"
                >
            </div>
        </div>

        <!-- DATA TABLE -->
        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Nome</th>
                            <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Telefone</th>
                            <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Cidade</th>
                            <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Bairro</th>
                            <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Endereço</th>
                            <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clientTableBody" class="divide-y divide-slate-100">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FOOTER STATS -->
        <div class="max-w-7xl mx-auto mt-6 flex justify-end">
            <div id="stats" class="text-xs font-mono text-slate-400 uppercase tracking-widest">
                Total: 0 | Armazenamento Local Ativo
            </div>
        </div>
    </div>

    <!-- MODAL (View/Edit/Create) -->
    <div id="clientModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in duration-200">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 id="modalTitle" class="text-xl font-bold text-slate-800 tracking-tight">Novo Cadastro</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="clientForm" onsubmit="handleSave(event)" class="p-6 space-y-4">
                <input type="hidden" id="clientId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Nome Completo</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" id="clientName" required class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Telefone</label>
                        <div class="relative">
                            <i data-lucide="phone" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" id="clientPhone" required class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Cidade</label>
                        <div class="relative">
                            <i data-lucide="map-pin" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" id="clientCity" required class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Bairro</label>
                        <input type="text" id="clientNeighborhood" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                    </div>

                    <div class="md:col-span-1">
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Endereço</label>
                        <input type="text" id="clientAddress" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Observações</label>
                        <textarea id="clientObs" rows="3" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none resize-none" placeholder="Notas importantes sobre o cliente..."></textarea>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-2.5 bg-slate-100 text-slate-600 rounded-lg font-semibold hover:bg-slate-200 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOTIFICATION SYSTEM -->
    <div id="notification" class="hidden fixed bottom-6 right-6 z-[100] flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl transition-all translate-x-12 opacity-0">
        <span id="notificationIcon"></span>
        <span id="notificationMessage" class="font-medium"></span>
    </div>

    <script>
        // --- DATA LAYER ---
        const DB_KEY = 'dona_antonia_clients_db';
        let clients = JSON.parse(localStorage.getItem(DB_KEY)) || [];

        // --- APP INITIALIZATION ---
        // Usamos DOMContentLoaded para garantir que o script do Lucide esteja disponível
        document.addEventListener('DOMContentLoaded', () => {
            refreshIcons();
            renderTable();
        });

        // Função central para recarregar ícones do Lucide
        function refreshIcons() {
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        // --- LOGIC ---
        function saveToStorage() {
            localStorage.setItem(DB_KEY, JSON.stringify(clients));
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('clientTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = clients
                .filter(c => 
                    c.name.toLowerCase().includes(search) || 
                    c.city.toLowerCase().includes(search) ||
                    (c.obs && c.obs.toLowerCase().includes(search))
                )
                .sort((a, b) => a.name.localeCompare(b.name));

            tbody.innerHTML = filtered.map(client => `
                <tr class="hover:bg-slate-50/50 transition-colors group">
                    <td class="px-6 py-4 font-semibold text-slate-800">${client.name}</td>
                    <td class="px-6 py-4 text-slate-600">${client.phone}</td>
                    <td class="px-6 py-4 text-slate-600">${client.city}</td>
                    <td class="px-6 py-4 text-slate-600">${client.neighborhood}</td>
                    <td class="px-6 py-4 text-slate-600 max-w-xs truncate">${client.address}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="openModal('${client.id}')" class="flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-semibold text-sm">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                Ver
                            </button>
                            <button onclick="deleteClient('${client.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 italic font-medium">Nenhum cliente cadastrado ou encontrado.</td></tr>`;
            }

            document.getElementById('stats').innerText = `Total: ${clients.length} | Cadastro Clientes Dona Antonia`;
            refreshIcons();
        }

        // --- MODAL & FORM CONTROLS ---
        function openModal(id = null) {
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('clientForm');
            
            form.reset();
            document.getElementById('clientId').value = '';

            if (id) {
                const client = clients.find(c => c.id === id);
                if (client) {
                    title.innerText = "Ficha do Cliente";
                    document.getElementById('clientId').value = client.id;
                    document.getElementById('clientName').value = client.name;
                    document.getElementById('clientPhone').value = client.phone;
                    document.getElementById('clientCity').value = client.city;
                    document.getElementById('clientNeighborhood').value = client.neighborhood;
                    document.getElementById('clientAddress').value = client.address;
                    document.getElementById('clientObs').value = client.obs || '';
                }
            } else {
                title.innerText = "Novo Cadastro";
            }

            modal.classList.remove('hidden');
            document.body.classList.add('modal-active');
            refreshIcons();
        }

        function closeModal() {
            document.getElementById('clientModal').classList.add('hidden');
            document.body.classList.remove('modal-active');
        }

        function handleSave(e) {
            e.preventDefault();
            const id = document.getElementById('clientId').value;
            
            const payload = {
                id: id || crypto.randomUUID(),
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                city: document.getElementById('clientCity').value,
                neighborhood: document.getElementById('clientNeighborhood').value,
                address: document.getElementById('clientAddress').value,
                obs: document.getElementById('clientObs').value,
                updatedAt: new Date().toISOString()
            };

            if (id) {
                clients = clients.map(c => c.id === id ? payload : c);
                notify("Ficha atualizada!");
            } else {
                clients.push(payload);
                notify("Novo cliente salvo!");
            }

            saveToStorage();
            closeModal();
        }

        function deleteClient(id) {
            if (confirm("Deseja apagar este cadastro permanentemente?")) {
                clients = clients.filter(c => c.id !== id);
                saveToStorage();
                notify("Registro removido", "error");
            }
        }

        // --- IMPORT / EXPORT ---
        function exportToJson() {
            if (clients.length === 0) return notify("O banco está vazio", "error");
            
            const dataStr = JSON.stringify(clients, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `CADASTRO-CLIENTE.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify("Exportação concluída!");
        }

        function importFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        if (confirm("Isso substituirá todos os dados atuais. Prosseguir com a importação?")) {
                            clients = imported;
                            saveToStorage();
                            notify(`${imported.length} registros importados`);
                        }
                    } else {
                        throw new Error("Estrutura JSON inválida");
                    }
                } catch (err) {
                    notify("Erro ao importar o arquivo", "error");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        // --- NOTIFICATIONS ---
        function notify(message, type = 'success') {
            const toast = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const msg = document.getElementById('notificationMessage');

            msg.innerText = message;
            toast.className = `fixed bottom-6 right-6 z-[100] flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl transition-all duration-300 opacity-100 translate-x-0 ${
                type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-900 text-white'
            }`;
            
            const iconName = type === 'error' ? 'alert-circle' : 'check-circle-2';
            icon.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 ${type !== 'error' ? 'text-emerald-400' : ''}"></i>`;
            
            refreshIcons();
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.classList.add('translate-x-12');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }
    </script>
</body>
</html>
