<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arch.Sales | Clientes</title>
    
    <!-- STACK DE ALTA DISPONIBILIDADE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .input-field {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1;
            border-radius: 0.5rem; font-weight: 600; outline: none; transition: 0.2s;
        }
        .input-field:focus { border-color: #2563eb; ring: 2px rgba(37,99,235,0.1); }
        .btn-primary { 
            background: #0f172a; color: white; padding: 0.6rem 1.2rem; 
            border-radius: 0.5rem; font-weight: 800; display: flex; align-items: center; gap: 0.5rem;
            transition: 0.2s;
        }
        .btn-primary:hover { background: #1e293b; transform: translateY(-1px); }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ENGINE DE ARMAZENAMENTO (ARCH-FS SIMPLIFICADO) ---
        const DB_KEY = 'ARCH_SALES_V1_CLIENTS';
        
        const ArchStorage = {
            getAll: () => {
                try {
                    const raw = localStorage.getItem(DB_KEY);
                    if (!raw) return ArchStorage.migrate();
                    return JSON.parse(raw);
                } catch (e) {
                    console.error("Erro no Storage", e);
                    return [];
                }
            },
            save: (data) => {
                try {
                    localStorage.setItem(DB_KEY, JSON.stringify(data));
                    return true;
                } catch (e) { return false; }
            },
            migrate: () => {
                const old = localStorage.getItem('db_clients_v5') || localStorage.getItem('db_clients');
                if (old) {
                    try {
                        const parsed = JSON.parse(old);
                        ArchStorage.save(parsed);
                        return parsed;
                    } catch (e) { return []; }
                }
                return [];
            }
        };

        // Componente de Ícone (Wrapper para Lucide)
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [clients, setClients] = useState(() => ArchStorage.getAll());
            const [selectedId, setSelectedId] = useState(null);
            const [search, setSearch] = useState('');
            const [form, setForm] = useState({ name: '', phone: '', city: 'CUIABÁ', district: '', purchaseCount: 0 });

            // Sincronização Automática
            useEffect(() => {
                ArchStorage.save(clients);
            }, [clients]);

            const handleSave = () => {
                if (!form.name) return;
                if (selectedId) {
                    setClients(clients.map(c => c.id === selectedId ? { ...form, id: selectedId } : c));
                } else {
                    const newClient = { ...form, id: Date.now().toString() };
                    setClients([...clients, newClient]);
                }
                reset();
            };

            const reset = () => {
                setForm({ name: '', phone: '', city: 'CUIABÁ', district: '', purchaseCount: 0 });
                setSelectedId(null);
            };

            const filtered = clients.filter(c => 
                c.name.toLowerCase().includes(search.toLowerCase()) || 
                (c.phone && c.phone.includes(search))
            ).sort((a,b) => a.name.localeCompare(b.name));

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    {/* LISTA */}
                    <aside className="w-80 bg-white border-r flex flex-col shrink-0">
                        <div className="p-4 border-b bg-slate-50">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="font-extrabold text-sm uppercase tracking-tighter flex items-center gap-2">
                                    <Icon name="users" className="text-blue-600"/> Clientes
                                </h1>
                                <span className="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold">{filtered.length}</span>
                            </div>
                            <div className="relative">
                                <input 
                                    className="w-full pl-8 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold outline-none focus:border-blue-500"
                                    placeholder="Pesquisar..."
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                />
                                <div className="absolute left-2.5 top-2.5 text-slate-400">
                                    <Icon name="search" size={14}/>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto scrollbar-hide">
                            {filtered.map(c => (
                                <div 
                                    key={c.id} 
                                    onClick={() => { setForm(c); setSelectedId(c.id); }}
                                    className={`p-4 border-b border-slate-50 cursor-pointer transition-colors ${selectedId === c.id ? 'bg-blue-50 border-l-4 border-blue-600' : 'hover:bg-slate-50 border-l-4 border-transparent'}`}
                                >
                                    <p className="font-bold text-xs uppercase truncate text-slate-800">{c.name}</p>
                                    <p className="text-[10px] text-slate-500 font-medium flex items-center gap-1 mt-1 uppercase">
                                        <Icon name="map-pin" size={10}/> {c.district || c.city}
                                    </p>
                                </div>
                            ))}
                        </div>

                        <div className="p-4 bg-slate-50 border-t">
                            <button onClick={reset} className="w-full btn-primary text-xs justify-center py-3">
                                <Icon name="plus" size={14}/> NOVO CADASTRO
                            </button>
                        </div>
                    </aside>

                    {/* FORMULÁRIO */}
                    <main className="flex-1 p-8 bg-slate-50 overflow-y-auto">
                        <div className="max-w-2xl mx-auto">
                            <div className="card shadow-sm">
                                <div className="p-6 border-b flex justify-between items-center bg-white">
                                    <h2 className="font-black text-lg uppercase tracking-tight text-slate-900">
                                        {selectedId ? 'Editar Cliente' : 'Nova Ficha'}
                                    </h2>
                                    <div className="flex gap-2">
                                        {selectedId && (
                                            <button onClick={() => { if(confirm("Apagar?")) { setClients(clients.filter(i=>i.id!==selectedId)); reset(); } }} className="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                                <Icon name="trash-2" size={20}/>
                                            </button>
                                        )}
                                        <button onClick={handleSave} className="btn-primary">
                                            <Icon name="save" size={18}/> SALVAR
                                        </button>
                                    </div>
                                </div>

                                <div className="p-8 grid grid-cols-2 gap-6">
                                    <div className="col-span-2">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Nome do Cliente</label>
                                        <input 
                                            className="input-field uppercase text-sm" 
                                            value={form.name} 
                                            onChange={e => setForm({...form, name: e.target.value.toUpperCase()})}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">WhatsApp</label>
                                        <input 
                                            className="input-field text-sm" 
                                            value={form.phone} 
                                            onChange={e => setForm({...form, phone: e.target.value})}
                                            placeholder="(65) 9..."
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Compras</label>
                                        <input 
                                            type="number"
                                            className="input-field text-sm bg-blue-50 text-blue-700 border-blue-200" 
                                            value={form.purchaseCount} 
                                            onChange={e => setForm({...form, purchaseCount: parseInt(e.target.value) || 0})}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Bairro</label>
                                        <input 
                                            className="input-field uppercase text-sm" 
                                            value={form.district} 
                                            onChange={e => setForm({...form, district: e.target.value.toUpperCase()})}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Cidade</label>
                                        <input 
                                            className="input-field uppercase text-sm" 
                                            value={form.city} 
                                            onChange={e => setForm({...form, city: e.target.value.toUpperCase()})}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="mt-8 flex justify-center items-center gap-4 text-slate-400">
                                <div className="flex items-center gap-1.5 text-[9px] font-bold uppercase tracking-widest">
                                    <div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div> 
                                    Sistema Ativo
                                </div>
                                <div className="flex items-center gap-1.5 text-[9px] font-bold uppercase tracking-widest">
                                    <div className="w-1.5 h-1.5 rounded-full bg-blue-500"></div> 
                                    Local-First
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
