<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo WMS (Micro-frontend)</title>
    
    <!-- 1. TAILWIND CSS (PROTOCOL) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 
                            850: '#151e2e', 
                            900: '#0f172a' 
                        },
                        primary: { 
                            600: '#0284c7', 
                            700: '#0369a1' 
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'sharp': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'input': '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    
    <!-- 2. GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- 3. ESTILOS GLOBAIS (PROTOCOL) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #e2e8f0; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; border: 2px solid #e2e8f0; }
        
        /* Inputs High Contrast */
        .input-label {
            display: block; font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.05em; font-weight: 700; color: #475569; margin-bottom: 0.35rem;
        }
        
        .input-field {
            width: 100%; padding: 0.6rem 0.75rem; 
            background-color: #ffffff; 
            border: 1px solid #cbd5e1; /* Slate-300 */
            border-radius: 0.375rem; font-size: 0.9rem; font-weight: 500; color: #0f172a;
            outline: none; transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .input-field:focus { 
            border-color: #0284c7; /* Primary-600 */
            box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.15); 
        }
        
        /* Botões Protocolo */
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 0.65rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 600; letter-spacing: 0.025em;
            transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        .btn-primary:hover { background-color: #1e293b; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background-color: #ffffff; border: 1px solid #cbd5e1; color: #334155;
            padding: 0.65rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 600;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            text-transform: uppercase;
        }
        .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; color: #0f172a; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.2s ease-out; }
    </style>

    <!-- 4. IMPORTMAP -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 5. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-900">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Package, Truck, Printer, CheckCircle, Clock, 
          AlertTriangle, ArrowRight, RotateCcw, Trash2, 
          Box, FileText, User, MapPin, ClipboardList, Search
        } from 'lucide-react';

        // --- UTILS ---
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        // --- APP CONTAINER ---
        function App() {
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);

          return (
            <div className="h-screen bg-slate-100 font-sans text-slate-900 overflow-hidden relative flex flex-col">
                <ExpeditionHeader sales={sales} />
                <ExpeditionBoard 
                    sales={sales} 
                    setSales={setSales} 
                    clients={clients} 
                    products={products} 
                    setProducts={setProducts} 
                />
            </div>
          );
        }

        // --- HEADER COMPONENT (Standardized) ---
        function ExpeditionHeader({ sales }) {
            const pendingCount = sales.filter(s => s.status === 'Pendente').length;
            const packingCount = sales.filter(s => s.status === 'Montagem').length;

            return (
                <header className="h-16 bg-white border-b border-slate-300 px-6 flex items-center justify-between shrink-0 shadow-sm z-20">
                    <div className="flex items-center gap-3">
                        <div className="h-8 w-1 bg-slate-900 rounded-full"></div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-900 leading-tight uppercase tracking-tight">Expedição & WMS</h2>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Controle Logístico</p>
                        </div>
                    </div>
                    <div className="flex gap-4">
                        <div className="flex items-center gap-3">
                            <div className="text-right">
                                <span className="block text-[10px] font-bold text-slate-400 uppercase">Aguardando</span>
                                <span className="block text-lg font-bold text-slate-800 leading-none">{pendingCount}</span>
                            </div>
                            <div className="h-8 w-px bg-slate-200"></div>
                            <div className="text-right">
                                <span className="block text-[10px] font-bold text-slate-400 uppercase">Em Montagem</span>
                                <span className="block text-lg font-bold text-primary-600 leading-none">{packingCount}</span>
                            </div>
                        </div>
                    </div>
                </header>
            );
        }

        // --- KANBAN BOARD ---
        function ExpeditionBoard({ sales, setSales, clients, products, setProducts }) {
            
            // Actions logic (Same as before)
            const updateStatus = (saleId, newStatus) => {
                setSales(sales.map(s => s.id === saleId ? { ...s, status: newStatus } : s));
            };

            const returnStock = (sale) => {
                 const newProducts = [...products];
                 sale.items.forEach(item => {
                  const dbProd = newProducts.find(p => p.id === item.id);
                  if (dbProd) {
                    if (dbProd.isCombo) { 
                        item.comboItems?.forEach(ing => { 
                            const dbIng = newProducts.find(p => p.id === ing.id); 
                            if (dbIng) { dbIng.stock += ing.qty; } 
                        }); 
                    } else { dbProd.stock += 1; }
                  }
                 });
                 setProducts(newProducts);
            };

            const deleteSale = (sale) => { 
                if (!confirm(`CONFIRMAÇÃO:\nCancelar pedido #${sale.id} e estornar estoque?`)) return; 
                returnStock(sale); 
                setSales(sales.filter(s => s.id !== sale.id)); 
            };

            const revertStatus = (sale) => {
                if (sale.status === 'Rota') updateStatus(sale.id, 'Montagem');
                else if (sale.status === 'Montagem') updateStatus(sale.id, 'Pendente');
            };

            // Simplified Print logic for Demo
            const printLabel = (sale, client) => { alert(`Imprimindo Etiqueta #${sale.id} para ${client.name}...`); };
            const printPickingList = (sale) => { alert(`Imprimindo Lista de Separação #${sale.id}...`); };

            const activeSales = sales
                .filter(s => s.status !== 'Entregue' && s.status !== 'Concluído' && s.status !== 'Cancelado')
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            return (
                <div className="flex-1 overflow-x-auto p-6 bg-slate-100">
                    <div className="flex flex-col md:flex-row gap-6 h-full min-w-[1000px] md:min-w-0">
                        
                        {/* COLUNA 1: PENDENTE */}
                        <KanbanColumn title="Aguardando Separação" count={activeSales.filter(s => s.status === 'Pendente').length}>
                            {activeSales.filter(s => s.status === 'Pendente').map(s => {
                                const client = clients.find(c=>c.id===s.clientId) || {name: 'Consumidor Final'};
                                return (
                                    <OrderCard key={s.id} sale={s} client={client}>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => printPickingList(s)} className="btn-secondary flex-1 text-[10px] py-1.5 h-8">
                                                <FileText size={14}/> Lista
                                            </button>
                                            <button onClick={() => printLabel(s, client)} className="btn-secondary flex-1 text-[10px] py-1.5 h-8">
                                                <Printer size={14}/> Etiqueta
                                            </button>
                                        </div>
                                        <button onClick={() => updateStatus(s.id, 'Montagem')} className="btn-primary w-full text-xs py-2 shadow-sm">
                                            INICIAR MONTAGEM <ArrowRight size={14}/>
                                        </button>
                                        <div className="mt-3 flex justify-center">
                                            <button onClick={() => deleteSale(s)} className="text-[10px] text-slate-400 hover:text-red-600 font-bold uppercase tracking-wide flex items-center gap-1 transition">
                                                <Trash2 size={10}/> Cancelar
                                            </button>
                                        </div>
                                    </OrderCard>
                                );
                            })}
                        </KanbanColumn>
                        
                        {/* COLUNA 2: EM MONTAGEM */}
                        <KanbanColumn title="Conferência & Montagem" count={activeSales.filter(s => s.status === 'Montagem').length} active>
                            {activeSales.filter(s => s.status === 'Montagem').map(s => {
                                const client = clients.find(c=>c.id===s.clientId) || {name: 'Consumidor Final'};
                                return (
                                    <OrderCard key={s.id} sale={s} client={client} highlight>
                                        <div className="bg-slate-50 p-2.5 rounded text-[10px] text-slate-600 mb-3 border border-slate-200 flex items-start gap-2 font-medium">
                                            <Box size={14} className="mt-0.5 shrink-0 text-primary-600"/>
                                            <span>Conferir <strong>{s.items.length} itens</strong>.</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => revertStatus(s)} className="p-2 bg-white text-slate-400 rounded hover:bg-slate-50 border border-slate-200" title="Voltar"><RotateCcw size={16}/></button>
                                            <button onClick={() => updateStatus(s.id, 'Rota')} className="btn-primary flex-1 bg-primary-600 hover:bg-primary-700 border-transparent text-xs py-2 shadow-sm">
                                                <CheckCircle size={14}/> LIBERAR ROTA
                                            </button>
                                        </div>
                                    </OrderCard>
                                );
                            })}
                        </KanbanColumn>
                        
                        {/* COLUNA 3: PRONTO PARA ROTA */}
                        <KanbanColumn title="Expedido / Rota" count={activeSales.filter(s => s.status === 'Rota').length}>
                            {activeSales.filter(s => s.status === 'Rota').map(s => {
                                const client = clients.find(c=>c.id===s.clientId) || {name: 'Consumidor Final'};
                                return (
                                    <OrderCard key={s.id} sale={s} client={client}>
                                        <div className="text-center py-3 bg-slate-50 border border-slate-200 rounded mb-2">
                                            <Truck size={24} className="mx-auto text-slate-400 mb-1"/>
                                            <p className="text-[10px] font-bold text-slate-500 uppercase">Aguardando Coleta</p>
                                        </div>
                                        <div className="text-center">
                                            <button onClick={() => revertStatus(s)} className="text-[10px] text-slate-300 hover:text-slate-500 font-bold uppercase tracking-wide underline">
                                                Corrigir
                                            </button>
                                        </div>
                                    </OrderCard>
                                );
                            })}
                        </KanbanColumn>

                    </div>
                </div>
            );
        }

        // --- SUB-COMPONENTS (Strict Protocol) ---
        const KanbanColumn = ({ title, count, active, children }) => {
            return (
                <div className="flex flex-col h-full flex-1 bg-slate-200/50 rounded-lg overflow-hidden border border-slate-300 shadow-sm">
                    <div className="p-3 px-4 bg-white border-b border-slate-200 flex justify-between items-center sticky top-0 z-10">
                        <span className="text-xs font-black text-slate-700 uppercase tracking-wider flex items-center gap-2">
                            {title}
                        </span>
                        <span className={`px-2 py-0.5 rounded text-[10px] font-black ${active ? 'bg-primary-600 text-white' : 'bg-slate-100 text-slate-500'}`}>
                            {count}
                        </span>
                    </div>
                    <div className="flex-1 overflow-y-auto p-3 space-y-3 scrollbar-thin">
                        {children}
                        {count === 0 && (
                            <div className="h-40 flex flex-col items-center justify-center text-slate-300 italic text-[10px] uppercase font-bold tracking-wide">
                                <Package size={24} className="mb-2 opacity-30"/>
                                Vazio
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const OrderCard = ({ sale, client, highlight, children }) => (
            <div className={`bg-white p-4 rounded border shadow-sm transition-all animate-in ${highlight ? 'border-primary-600 ring-1 ring-primary-600 shadow-md' : 'border-slate-300 hover:border-slate-400'}`}>
                <div className="flex justify-between items-start mb-3">
                    <div className="flex items-center gap-2">
                        <span className="font-mono font-bold text-sm text-slate-900 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">#{sale.id}</span>
                        <span className="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1">
                            <Clock size={10}/> {new Date(sale.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    </div>
                    <div className="text-right">
                        <span className="block text-[10px] font-black text-slate-600 uppercase tracking-wider bg-slate-50 px-1.5 py-0.5 rounded border border-slate-200">
                            {sale.regionOverride || client.region || 'S/ ROTA'}
                        </span>
                    </div>
                </div>
                
                <div className="mb-4">
                    <h3 className="font-bold text-slate-800 text-xs leading-tight flex items-start gap-1 mb-0.5">
                        <User size={12} className="mt-0.5 text-slate-400 shrink-0"/> {client.name}
                    </h3>
                    <p className="text-[10px] font-medium text-slate-500 ml-4 truncate uppercase">{client.district || 'Bairro N/D'}</p>
                    
                    {sale.obs && (
                        <div className="mt-2 bg-white text-slate-600 text-[10px] p-2 rounded border border-slate-200 border-l-4 border-l-slate-400 flex items-start gap-1 font-medium">
                            <AlertTriangle size={12} className="mt-0.5 shrink-0 text-slate-400"/> 
                            <span className="uppercase">{sale.obs}</span>
                        </div>
                    )}
                </div>

                {children}
            </div>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
