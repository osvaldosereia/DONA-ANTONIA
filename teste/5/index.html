<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log√≠stica Local-First | Entregador</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        primary: { 600: '#0284c7', 700: '#0369a1' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 0.75rem 1.25rem; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 800; text-transform: uppercase;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary {
            background-color: #ffffff; border: 2px solid #e2e8f0; color: #1e293b;
            padding: 0.75rem 1.25rem; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 700; text-transform: uppercase;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .highlight-card { border-left: 6px solid #0f172a; }
        .done-card { opacity: 0.6; grayscale: 100%; order: 9999; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: slideUp 0.3s ease-out forwards; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Truck, MapPin, Navigation, Phone, CheckCircle, XCircle, 
          ArrowUp, ArrowDown, Share2, Upload, DollarSign, CreditCard, 
          MessageSquare, Menu, X, Gift, Home, Clock, ExternalLink, Hash, Package
        } from 'lucide-react';

        // --- HOOKS & UTILS ---
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        const formatCurrency = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

        // --- MAIN APP ---
        function App() {
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [companyPhone] = useStickyState('db_config_phone', '5565999999999'); 
          
          const [viewMode, setViewMode] = useState('dashboard');
          const [driverData, setDriverData] = useState(null);

          useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#driver=')) {
                  try {
                    const encoded = hash.replace('#driver=', '');
                    const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                    setDriverData(decoded);
                    setViewMode('driver');
                  } catch (e) { setViewMode('dashboard'); }
                } else { if (viewMode === 'driver') setViewMode('dashboard'); }
            };
            checkHash();
            window.addEventListener('hashchange', checkHash);
            return () => window.removeEventListener('hashchange', checkHash);
          }, []);

          if (viewMode === 'driver') {
              return <DriverView data={driverData} onExit={() => { window.location.hash = ''; setViewMode('dashboard'); }} />;
          }

          return (
            <div className="h-screen flex flex-col">
                <header className="h-16 bg-white border-b border-slate-200 px-6 flex items-center justify-between shrink-0 shadow-sm">
                    <div className="flex items-center gap-3">
                        <Truck size={24} className="text-slate-900" />
                        <div>
                            <h2 className="text-xl font-black text-slate-900 leading-none uppercase tracking-tighter">Log√≠stica v2</h2>
                            <p className="text-[10px] text-slate-500 font-bold uppercase">Gest√£o Local-First</p>
                        </div>
                    </div>
                </header>
                <LogisticsManager 
                    sales={sales} setSales={setSales} 
                    clients={clients} companyPhone={companyPhone}
                    products={products} setProducts={setProducts} 
                />
            </div>
          );
        }

        // --- LOGISTICS DASHBOARD ---
        function LogisticsManager({ sales, setSales, clients, companyPhone, products, setProducts }) {
            const [selectedRoute, setSelectedRoute] = useState('Todas');
            const [routeSales, setRouteSales] = useState([]); 

            useEffect(() => { 
                const ready = sales.filter(s => s.status === 'Rota'); 
                const filtered = selectedRoute === 'Todas' ? ready : ready.filter(s => { 
                    if (s.regionOverride) return s.regionOverride === selectedRoute;
                    const c = clients.find(cl => cl.id === s.clientId); 
                    return (c?.region || c?.route) === selectedRoute; 
                }); 
                setRouteSales(filtered); 
            }, [sales, selectedRoute, clients]);
            
            const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];
            
            const generateDriverLink = () => { 
                if (routeSales.length === 0) return alert("Nenhum pedido em rota!"); 
                const payload = { 
                    route: selectedRoute, 
                    companyPhone, 
                    orders: routeSales.map(s => { 
                        const c = clients.find(cl => cl.id === s.clientId) || {}; 
                        return { 
                            id: s.id, 
                            customer: c.name || 'Consumidor', 
                            phone: c.phone, phone2: c.phone2, 
                            address: c.address, district: c.district, city: c.city || 'Cidade N√£o Inf.',
                            total: s.total, 
                            items: s.items || [],
                            pay: s.isPaid ? `${s.payMethod} (J√Å PAGO)` : s.payMethod, 
                            change: s.changeFor ? s.changeFor - s.total : 0, 
                            obs: s.obs, isPaid: s.isPaid
                        }; 
                    }) 
                }; 
                const encoded = encodeURIComponent(btoa(JSON.stringify(payload))); 
                const link = `${window.location.origin}${window.location.pathname}#driver=${encoded}`; 
                navigator.clipboard.writeText(link).then(() => alert("LINK DO ENTREGADOR COPIADO!"));
            };

            return (
                <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-100">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="w-full md:w-auto">
                                <label className="text-[10px] font-black uppercase text-slate-400 mb-1 block">Filtrar Regi√£o</label>
                                <select className="w-full md:w-64 p-2 rounded-lg border-2 border-slate-100 font-bold text-slate-700" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}>
                                    <option value="Todas">Todas as Rotas</option>
                                    {routes.map(r => <option key={r} value={r}>{r}</option>)}
                                </select>
                            </div>
                            <button onClick={generateDriverLink} className="btn-primary w-full md:w-auto">
                                <Share2 size={18}/> Gerar Link do Entregador
                            </button>
                        </div>

                        <div className="space-y-3">
                            {routeSales.map((s, idx) => (
                                <div key={s.id} className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <div className="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center font-black text-slate-400">{idx + 1}</div>
                                        <div>
                                            <p className="font-black text-slate-800 uppercase leading-none mb-1">#{s.id} - {clients.find(c => c.id === s.clientId)?.name}</p>
                                            <p className="text-xs text-slate-500 font-bold uppercase">{clients.find(c => c.id === s.clientId)?.address}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-black text-slate-900">{formatCurrency(s.total)}</p>
                                        <span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-black text-slate-500 uppercase">{s.payMethod}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- DRIVER VIEW (THE CORE IMPROVEMENT) ---
        function DriverView({ data, onExit }) {
          const [deliveryResults, setDeliveryResults] = useState({});
          const [confirmModal, setConfirmModal] = useState(null);

          // Sorting logic: Unfinished first, finished last
          const sortedOrders = useMemo(() => {
              return [...data.orders].sort((a, b) => {
                  const aDone = !!deliveryResults[a.id];
                  const bDone = !!deliveryResults[b.id];
                  return aDone === bDone ? 0 : aDone ? 1 : -1;
              });
          }, [data.orders, deliveryResults]);

          const sendWhatsApp = (phone, text) => {
              if(!phone) return;
              const cleanPhone = phone.replace(/\D/g, '');
              const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(text)}`;
              window.open(url, '_blank');
          };

          const handleFinish = (method) => {
              setDeliveryResults(prev => ({ ...prev, [confirmModal.id]: { status: 'Entregue', method } }));
              setConfirmModal(null);
          };

          const handleCancel = (id) => {
              if(confirm("Deseja cancelar esta entrega?")) {
                setDeliveryResults(prev => ({ ...prev, [id]: { status: 'Cancelado', method: 'N/A' } }));
              }
          };

          return (
            <div className="h-screen flex flex-col bg-slate-50 overflow-hidden">
                <header className="bg-slate-900 text-white px-4 py-3 flex justify-between items-center shadow-lg">
                    <div className="flex items-center gap-2">
                        <Truck className="text-primary-600" size={20} />
                        <h1 className="font-black uppercase text-sm tracking-widest">Rota: {data.route}</h1>
                    </div>
                    <button onClick={onExit} className="bg-slate-800 px-3 py-1 rounded-md text-[10px] font-black border border-slate-700">FECHAR</button>
                </header>

                <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-32">
                    {sortedOrders.map((order) => {
                        const result = deliveryResults[order.id];
                        const isDone = !!result;

                        return (
                            <div key={order.id} className={`bg-white rounded-xl shadow-md border-2 transition-all ${isDone ? 'done-card border-slate-200' : 'border-slate-300 highlight-card animate-in'}`}>
                                
                                {/* CABE√áALHO DO CARD */}
                                <div className="p-4 bg-slate-50 border-b-2 border-slate-100 flex justify-between items-start">
                                    <div className="flex flex-col">
                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">N√öMERO DO PEDIDO</span>
                                        <span className="text-3xl font-black text-slate-900 leading-none">#{order.id}</span>
                                    </div>
                                    <div className="text-right">
                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter block">STATUS</span>
                                        <span className={`text-xs font-black px-2 py-1 rounded ${isDone ? 'bg-slate-200 text-slate-500' : 'bg-primary-600 text-white'}`}>
                                            {isDone ? result.status.toUpperCase() : 'PENDENTE'}
                                        </span>
                                    </div>
                                </div>

                                <div className="p-5">
                                    <h2 className="text-2xl font-black text-slate-900 uppercase leading-tight mb-2">{order.customer}</h2>
                                    
                                    {/* ENDERE√áO EM DESTAQUE */}
                                    <div className="bg-amber-50 p-4 rounded-lg border-2 border-amber-100 mb-4">
                                        <div className="flex items-start gap-3">
                                            <MapPin className="text-amber-600 mt-1 shrink-0" size={24} />
                                            <div>
                                                <p className="text-lg font-black text-amber-900 uppercase leading-snug">{order.address}</p>
                                                <p className="text-sm font-bold text-amber-700 uppercase">{order.district} ‚Äî {order.city}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* PRODUTOS EM DESTAQUE */}
                                    <div className="mb-4">
                                        <span className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">ITENS DO PEDIDO</span>
                                        <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-1">
                                            {order.items && order.items.length > 0 ? (
                                                order.items.map((item, i) => (
                                                    <div key={i} className="flex justify-between items-center py-1 border-b border-slate-200 last:border-0">
                                                        <span className="font-bold text-slate-700 text-base uppercase">
                                                            <span className="text-primary-600">{item.qty}x</span> {item.name}
                                                        </span>
                                                        <span className="font-black text-slate-400">...</span>
                                                    </div>
                                                ))
                                            ) : (
                                                <p className="text-xs font-bold text-slate-400">Detalhamento n√£o dispon√≠vel</p>
                                            )}
                                        </div>
                                    </div>

                                    {/* FINANCEIRO EM DESTAQUE */}
                                    <div className="grid grid-cols-2 gap-3 mb-6">
                                        <div className="bg-slate-900 text-white p-4 rounded-lg">
                                            <span className="text-[10px] font-bold text-slate-400 block uppercase">TOTAL A RECEBER</span>
                                            <span className="text-xl font-black">{formatCurrency(order.total)}</span>
                                        </div>
                                        <div className="bg-slate-100 border border-slate-200 p-4 rounded-lg">
                                            <span className="text-[10px] font-bold text-slate-500 block uppercase">FORMA DE PGTO</span>
                                            <span className="text-base font-black text-slate-800 uppercase leading-none">{order.pay}</span>
                                        </div>
                                    </div>

                                    {!isDone && (
                                        <div className="space-y-4">
                                            {/* COMUNICA√á√ÉO - TELEFONE 1 */}
                                            <div className="space-y-2">
                                                <p className="text-[10px] font-black text-slate-400 uppercase">Contato Principal: {order.phone}</p>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={() => sendWhatsApp(order.phone, "Ol√°! Em 10 minutos sua cesta chega. üöö")} className="btn-secondary text-[10px] py-3 bg-blue-50 border-blue-200 text-blue-700">
                                                        <Clock size={16}/> Cesta em 10m
                                                    </button>
                                                    <button onClick={() => sendWhatsApp(order.phone, "Cheguei com sua entrega! üè†")} className="btn-secondary text-[10px] py-3 bg-green-50 border-green-200 text-green-700">
                                                        <Home size={16}/> Cheguei
                                                    </button>
                                                </div>
                                                <a href={`tel:${order.phone}`} className="btn-secondary w-full border-slate-300">
                                                    <Phone size={16}/> Ligar Normal
                                                </a>
                                            </div>

                                            {/* COMUNICA√á√ÉO - TELEFONE 2 (DUPLICADO SE EXISTIR) */}
                                            {order.phone2 && (
                                                <div className="pt-4 border-t-2 border-slate-100 space-y-2">
                                                    <p className="text-[10px] font-black text-slate-400 uppercase">Contato Secund√°rio: {order.phone2}</p>
                                                    <div className="grid grid-cols-2 gap-2 opacity-90">
                                                        <button onClick={() => sendWhatsApp(order.phone2, "Ol√°! Em 10 minutos sua cesta chega. üöö")} className="btn-secondary text-[10px] py-3 bg-slate-50 border-slate-200">
                                                            <Clock size={16}/> Cesta em 10m (2)
                                                        </button>
                                                        <button onClick={() => sendWhatsApp(order.phone2, "Cheguei com sua entrega! üè†")} className="btn-secondary text-[10px] py-3 bg-slate-50 border-slate-200">
                                                            <Home size={16}/> Cheguei (2)
                                                        </button>
                                                    </div>
                                                    <a href={`tel:${order.phone2}`} className="btn-secondary w-full border-slate-300">
                                                        <Phone size={16}/> Ligar Secund√°rio
                                                    </a>
                                                </div>
                                            )}

                                            <div className="grid grid-cols-2 gap-3 pt-4">
                                                <button onClick={() => handleCancel(order.id)} className="btn-secondary text-red-600 border-red-100 bg-red-50 py-4">
                                                    <XCircle size={20}/> Cancelar
                                                </button>
                                                <button onClick={() => setConfirmModal(order)} className="btn-primary bg-green-600 hover:bg-green-700 py-4 shadow-lg shadow-green-200">
                                                    <CheckCircle size={20}/> Concluir
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>

                {/* MODAL DE BAIXA */}
                {confirmModal && (
                    <div className="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4">
                        <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in">
                            <h3 className="text-xl font-black text-slate-900 mb-2 uppercase text-center">Confirmar Entrega</h3>
                            <p className="text-xs text-slate-500 font-bold text-center mb-6">COMO O CLIENTE PAGOU O PEDIDO #{confirmModal.id}?</p>
                            
                            <div className="grid grid-cols-1 gap-3">
                                <button onClick={() => handleFinish('DINHEIRO')} className="w-full py-4 rounded-xl border-2 border-slate-200 font-black text-slate-700 hover:bg-green-50 hover:border-green-600 hover:text-green-800 transition-all">DINHEIRO</button>
                                <button onClick={() => handleFinish('PIX')} className="w-full py-4 rounded-xl border-2 border-slate-200 font-black text-slate-700 hover:bg-indigo-50 hover:border-indigo-600 hover:text-indigo-800 transition-all">PIX</button>
                                <button onClick={() => handleFinish('CART√ÉO')} className="w-full py-4 rounded-xl border-2 border-slate-200 font-black text-slate-700 hover:bg-blue-50 hover:border-blue-600 hover:text-blue-800 transition-all">CART√ÉO</button>
                                <button onClick={() => handleFinish('J√Å PAGO')} className="w-full py-4 rounded-xl border-2 border-slate-200 font-black text-slate-700 bg-slate-50 hover:bg-slate-200 transition-all uppercase">J√° Estava Pago</button>
                            </div>
                            
                            <button onClick={() => setConfirmModal(null)} className="w-full mt-6 py-2 text-xs font-black text-slate-400 uppercase tracking-widest">Voltar</button>
                        </div>
                    </div>
                )}

                {/* RELAT√ìRIO FINAL */}
                {Object.keys(deliveryResults).length === data.orders.length && (
                    <div className="fixed bottom-0 left-0 w-full p-4 bg-white border-t-2 border-slate-200 z-40">
                        <button onClick={() => {
                            let r = `*RELAT√ìRIO DE FINALIZA√á√ÉO*\n\n`;
                            Object.entries(deliveryResults).forEach(([id, res]) => {
                                r += `üì¶ *Pedido #${id}*: ${res.status} | ${res.method}\n`;
                            });
                            sendWhatsApp(data.companyPhone, r);
                        }} className="btn-primary w-full py-5 bg-green-600 shadow-xl shadow-green-200">
                            <MessageSquare size={20}/> Enviar Relat√≥rio de Campo
                        </button>
                    </div>
                )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
